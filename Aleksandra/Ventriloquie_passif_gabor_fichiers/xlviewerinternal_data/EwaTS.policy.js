'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[46],{864:function(z,t,a){a.r(t);var c={};a.r(c);a.d(c,"SensitivityCommandHandler",function(){return v});var b=a(135),h=a(0),r=a(6),e=a(211);class k{}k.$Uk="sbProtectForm14";k.cVk="SBStatusBarMarkAsReadOnly14";k.iwj="Info_16x16x32";k.LKb="QuickSearchCompletedToday_16x16x32";k.Ufe="CommonControlCheckboxCheck_16";k.Y0g="On";k.visible="Visible";k.nyi="ImageIsVisible";k.gF="SourceControlId";k.menuItemId="MenuItemId";
k.menu="Menu";k.zqd="AppLockId";k.value="Value";k.yo="LabelText";k.alt="Alt";k.QTf="Image16by16";k.Ina="Image16by16Class";k.ZUk="SBProtectForm_16";k.bVk="SBStatusBarMarkAsReadOnly_16";k.icon="Icon";k.iconColor="IconColor";k.customTooltip="CustomTooltip";k.jek="MipTagDynamicFillWithOutline_20";k.kek="MipTagLockDynamicFillWithOutline_20";k.iek="MipTagErrorOutline_20";k.lek="MipTagQuestionOutline_20";k.U1c="transparent";k.X3k="UILocation";Object(h.a)(k,"PolicyConstants",null,[]);var m=a(26),x=a(67),
n=a(5),u=a(95);let v=class{constructor(Rb){this.$=Rb}Ri(){return!1}executeCommand(Rb,dc,$a){switch(dc.command){case m.a.setSensitivity:return this.$.workbookContext.FileCoauthorable||($a[k.zqd]=this.$.workbookContext.ExclusiveLockId),Rb=r.AFrameworkApplication.yh.ek(m.a.setSensitivity,2,$a),x.Task.Ua(32===Rb);case m.a.Xba:return Rb=r.AFrameworkApplication.yh.ek(m.a.Xba,2,$a),x.Task.Ua(32===Rb);case m.a.u7:return Rb=r.AFrameworkApplication.yh.ek(m.a.u7,2,$a),x.Task.Ua(32===Rb);default:return e.a(dc.command)}}Gi(Rb,
dc){switch(dc.command){case m.a.setSensitivity:case m.a.Xba:case m.a.u7:return!0;default:return!1}}dj(Rb,dc,$a){switch(dc){case "PopulateSensitivityFlyout":return 32===r.AFrameworkApplication.yh.ek(m.a.NNa,2,$a);default:return!1}}};v=Object(b.__decorate)([Object(u.d)(n.Df),Object(b.__param)(0,Object(n.Nb)())],v);Object(h.a)(v,"SensitivityCommandHandler",null,[43]);var w=a(42),l=a(1192),y=a(1495),B=a(285);const A=()=>w.a.instance.resolve("Common.App.Policy.Contracts.IPolicyManager");var E=a(15),N=
a(142),D=a(1174),U=a(650),K=a(210),M=a(648);class O{constructor(Rb,dc,$a=null){this.id=Rb.Id;$a||($a="");this.mfk=$a;this.sensitivityLabel=Rb}}Object(h.a)(O,"AutoPolicyLabelData",null,[]);class R{constructor(Rb,dc){this.tX=Rb;this.displayName=dc}}Object(h.a)(R,"PolicyLabelRequestState",null,[]);class J{constructor(){this.Cne=this.o7d=""}}Object(h.a)(J,"PolicyStrings",null,[]);var aa=a(240),S=a(22);class C extends aa.a{constructor(Rb,dc){super(!1,!1,!0);this.rEa=null;this.icc=!1;this.FAg=$a=>{let Wb=
"";1===$a&&this.rEa&&(Wb=this.rEa);this.IN($a,this.rsh,Wb)};this.xVj=$a=>{this.rEa=$a;$a=this.validate();this.icc!==$a&&(this.icc=$a,this.IQa(Object(S.a)("SensitivityJustificationTitle"),this.FAg,this.KKf(this.icc)))};this.rsh=Rb;this.IN=dc;this.kl=C.id;this.ri(1,Object(S.a)("DialogChange"));this.Z7(1,!1);this.Oia(0)}ite(){this.initializeAndShow(Object(S.a)("SensitivityJustificationTitle"),this.FAg,this.KKf(this.icc))}KKf(Rb){return{["id"]:this.kl,["bodyControls"]:{["choiceGroupProps"]:{},["textAreaProps"]:{["placeholder"]:Object(S.a)("SensitivityJustificationPlaceholder")}},
["actionButtonProps"]:{["label"]:Object(S.a)("DialogChange"),["disabled"]:!Rb},["infoMessage"]:Object(S.a)("SensitivityJustificationMessage"),["justificationIrrelevantLabel"]:Object(S.a)("SensitivityJustificationNoLongerApplies"),["justificationIncorrectLabel"]:Object(S.a)("SensitivityJustificationIncorrect"),["justificationOtherLabel"]:Object(S.a)("SensitivityJustificationOther"),["onJustificationUpdated"]:this.xVj}}static get D2(){return r.AFrameworkApplication.ra.$g.VM&&r.AFrameworkApplication.ra.$g.O1f}}
C.id="JustificationDialog";Object(h.a)(C,"JustificationDialog",aa.a,[]);class L extends aa.a{constructor(Rb,dc,$a){super(!1,!1,!0);this.TDj=(rc,xb)=>{1===rc&&xb.selectedLabel&&(rc=xb.selectedLabel,""!==rc&&this.qkh(rc))};if(Rb&&$a){var Wb={["id"]:"MandatoryLabellingDialog"};this.qkh=$a;this.Qed=dc;if(!r.AFrameworkApplication.fa.ka("MandatoryLabelingDialogLearnMoreSwitchIsEnabled")||this.Qed&&""!==this.Qed)dc={["href"]:this.Qed,["target"]:"_blank"},Wb.learnMoreLink={["type"]:"AppLinkProps",["id"]:"mandatoryLabellingLearnMoreLink",
["text"]:Object(S.a)("LearnMore"),["handler"]:dc,["customTooltip"]:Object(S.a)("LearnMoreTooltip")};dc={["sections"]:[],["shouldAutoOpen"]:!1};Array.add(dc.sections,{["id"]:"mandatoryLabellingFlyoutMenuSection",["controls"]:Rb});Wb.labelFlyout={["type"]:"AppFlyoutAnchorProps",["id"]:"mandatoryLabellingFyout",["label"]:"Pick a label",["hideLabel"]:!1,["hideChevron"]:!1,["hideIcon"]:!0,["menuDefinition"]:dc};Rb={["id"]:"MandatoryLabellingDialog",["bodyControls"]:Wb};Wb.initialLabelText=Object(S.a)("MandatoryLabellingDialogInitialLabelText");
Wb.descriptionText=Object(S.a)("MandatoryLabellingDialogDescriptionText");this.initializeAndShow(Object(S.a)("MandatoryLabellingDialogBusinessBarTitle"),this.TDj,Rb)}else E.ULS.sendTraceTag(560547850,306,10,"MandatoryLabelingDialog was triggered with invalid inputs")}}Object(h.a)(L,"MandatoryLabellingDialog",aa.a,[]);class V{constructor(){this.sDb=!!r.AFrameworkApplication.ra&&r.AFrameworkApplication.ra.$g.VM}t7h(Rb,dc,$a){this.sDb&&new L(Rb,dc,$a)}static get instance(){return V.Va||(V.Va=new V)}}
V.Va=null;Object(h.a)(V,"MandatoryLabellingDialogFactory",null,[608]);var X=a(687),la=a(289),Va=a(227),na=a(664),db=a(107),ja=a(169),ea=a(101),Z=a(488),ba=a(432),ya=a(117),Qa=a(498),va=a(188),Ia=a(482),Sa=a(125),Xa=a(33),da=a(136),Ea=a(357),qa=a(113);const za=Rb=>{var dc;return Rb?Rb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",!1):null===(dc=r.AFrameworkApplication.fa)||void 0===dc?void 0:dc.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",
!1)};class ma extends Sys.EventArgs{constructor(){super()}}Object(h.a)(ma,"WatermarkChangeEventArgs",Sys.EventArgs,[]);class Da{constructor(Rb,dc,$a,Wb,rc=[]){this.HDb=this.rsa=null;this.Bdd=this.Vdd=this.wDb=this.oQe=this.$Re=this.Z9c=!1;this.qab=this.Sra=this.Kka=this.nDa=this.rEa=this.k3=this.TEa=this.Hda=null;this.Hjh=this.J7c=0;this.thd=null;this.hh=new qa.a;this.RDb="";this.LGb=new Map;this.OLe=this.Rdd=this.Y7c=null;this.Dgk=()=>{this.Bdd&&!this.uGc()&&(this.Bdd=!1,this.$l.value.Cgk())};this.SDj=
xb=>{this.nEd(this.aSe[xb])};this.Bee=()=>{if(!this.$l.value.L2f()){var xb=this.FC[this.rm.AppliedPolicyId];this.wDb&&this.nDa&&this.qab!==this.nDa.id&&(!xb||xb.Order<this.nDa.sensitivityLabel.Order)&&(xb=this.N7a(this.nDa.id,{},4),32!==xb?E.ULS.sendTraceTag(50868813,306,10,"ProcessAutoSensitivityLabel: SetSensitivityByPolicyId failed with response: "+xb):(this.qab=this.nDa.id,this.Sra&&(xb=this.FC[this.Sra])&&xb.Order<=this.nDa.sensitivityLabel.Order&&(this.$l.value.dqa(29),this.Sra=null)));xb=this.FC[this.rm.AppliedPolicyId];
if(this.Kka&&this.Sra!==this.Kka.id&&(!xb||xb.Order<this.Kka.sensitivityLabel.Order)){const ic=this.Kka.id;this.$l.value.dqa(29);xb=za(this.Ha)?this.$l.value.kna(this.Kka.sensitivityLabel):this.kna(this.Kka.sensitivityLabel);this.$l.value.mHb(29,Object(S.a)("PolicyBusinessBarTitle"),String.format(Object(S.a)("PolicyLabelRecommendationMessage"),xb)+" "+this.Kka.mfk,Object(S.a)("PolicyLabelRecommendationButton"),()=>{this.N7a(ic,{},8)});this.Sra=this.Kka.id}this.Kka=this.nDa=null}};this.W1h=(xb,ic,
Rc)=>{1===xb?this.Kwb(ic===this.rm.AppliedPolicyId?"":ic,Rc):this.Km.UB()};this.YMh=xb=>{1===xb&&this.$l.value.idk()};this.rvc=()=>32;this.E0j=(xb,ic)=>{ic.H1&&this.FC&&(xb=this.FC[this.rm.AppliedPolicyId])&&(this.Sra&&(ic=this.FC[this.Sra])&&ic.Order<=xb.Order&&(this.$l.value.dqa(29),this.Sra=null),this.qab&&this.qab!==xb.Id&&(this.$l.value.dqa(28),this.qab=null))};this.$f=Rb;this.Km=dc;this.Ha=$a;this.$l=Wb;this.mEb={};this.cVe={};this.aSe={};this.JFc=$a.ka("WacApplyManualPolicyLabelIsEnabled");
this.$l.value.X4e(this.Bee);this.$l.value.vpd(this.Bee);this.$l.value.RHb(this.E0j);r.AFrameworkApplication.ra&&r.AFrameworkApplication.ra.qDh(this.Dgk);this.h1a()&&rc.forEach(xb=>this.LGb.set(xb.watermarkElement,xb));$a.ka("SupportsPolicies")&&$a.Za("AppliedPolicyId")&&(this.rsa=$a.Za("IrmPolicyTitle"),this.HDb=$a.Za("IrmPolicyDescription"));this.Vhh=this.Ha.Lj("SetPolicyLabelAwaitFileExistsOnHostMaxRetries",6);this.Whh=this.Ha.Lj("SetPolicyLabelAwaitFileExistsOnHostRetryDelayMs",5E3)}get kLa(){return r.AFrameworkApplication.kLa||
!!this.Rdd&&this.Rdd()}ho(){this.$f.Uh(m.a.Xae,da.a.frame,this.rvc);this.$f.Zk(m.a.jub,da.a.frame,Object(N.a)(this,this.jub,"queryPolicyLabel"),96);this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpQueryShortLabelEnabled",!1)&&(this.$f.Uh(m.a.Wsg,da.a.frame,this.rvc),this.$f.Zk(m.a.q3b,da.a.frame,Object(N.a)(this,this.q3b,"queryPolicyShortLabel"),96));this.$f.Uh(m.a.w9a,da.a.frame,Object(N.a)(this,this.w9a,"toggleSensitivity"));this.$f.Uh(m.a.NNa,da.a.frame,Object(N.a)(this,this.NNa,
"populateSensitivityFlyout"));this.$f.Uh(m.a.setSensitivity,da.a.frame,Object(N.a)(this,this.setSensitivity,"setSensitivity"));this.$f.Zk(m.a.kub,da.a.frame,Object(N.a)(this,this.kub,"querySensitivity"),96);this.$f.Uh(m.a.u7,da.a.frame,Object(N.a)(this,this.u7,"querySensitivityToggleButton"));this.$f.Uh(m.a.Xba,da.a.frame,Object(N.a)(this,this.Xba,"querySensitivitySubFlyout"));this.SGb(m.a.w9a)||this.$f.wwb(m.a.w9a,4);this.SGb(m.a.NNa)||this.$f.wwb(m.a.NNa,4);this.SGb(m.a.setSensitivity)||this.$f.wwb(m.a.setSensitivity,
4);this.SGb(m.a.u7)||this.$f.wwb(m.a.u7,4);this.SGb(m.a.Xba)||this.$f.wwb(m.a.Xba,4);this.Km.UB();r.AFrameworkApplication.fa&&ya.a("isSharedUxGateEnabled")&&appChrome.api.isSharedUxGateEnabled("SharedOnline.ChangeGate.DelayPolicyActionRegistration")&&this.$l.value.Pmk(Object(N.a)(this,this.uCg,"registerActionsHandler"))}uCg(){this.ho()}t2c(){this.$f.ZD(m.a.Xae,da.a.frame,this.rvc);this.$f.ZD(m.a.jub,da.a.frame,Object(N.a)(this,this.jub,"queryPolicyLabel"));this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpQueryShortLabelEnabled",
!1)&&(this.$f.ZD(m.a.Wsg,da.a.frame,this.rvc),this.$f.ZD(m.a.q3b,da.a.frame,Object(N.a)(this,this.q3b,"queryPolicyShortLabel")));this.$f.ZD(m.a.w9a,da.a.frame,Object(N.a)(this,this.w9a,"toggleSensitivity"));this.$f.ZD(m.a.NNa,da.a.frame,Object(N.a)(this,this.NNa,"populateSensitivityFlyout"));this.$f.ZD(m.a.setSensitivity,da.a.frame,Object(N.a)(this,this.setSensitivity,"setSensitivity"));this.$f.ZD(m.a.kub,da.a.frame,Object(N.a)(this,this.kub,"querySensitivity"));this.$f.ZD(m.a.u7,da.a.frame,Object(N.a)(this,
this.u7,"querySensitivityToggleButton"));this.$f.ZD(m.a.Xba,da.a.frame,Object(N.a)(this,this.Xba,"querySensitivitySubFlyout"))}w9a(){return 32}VDf(Rb){const dc="mandatoryLabelling_"+Rb.Id;this.aSe[dc]=Rb.Id;return{["type"]:"AppToggleButtonProps",["id"]:dc,["label"]:Rb.DisplayName,["hideLabel"]:!1,["customTooltip"]:Rb.Tooltip}}sXd(){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelEnabled",!1)}get rm(){if(za(this.Ha))return this.$l.value.Nn;this.Hda||(this.Hda=this.$l.value.Nn);
return this.Hda}get FC(){return za(this.Ha)?this.$l.value.VW:this.k3}get U4a(){return za(this.Ha)?this.$l.value.QEb:this.TEa}APi(){const Rb=[];for(const $a in this.U4a){var dc=this.U4a[$a];const Wb=this.FC[$a];if(Wb&&Wb.Enabled&&!Wb.HasUserDefinedPermissions)if(dc.count){const rc={["sections"]:[],["shouldAutoOpen"]:!1},xb={["id"]:"mandatoryLabelling_flyoutMenuSection_"+Wb.Id,["controls"]:[]};for(const ic of dc)(dc=this.FC[ic])&&dc.Enabled&&!dc.HasUserDefinedPermissions&&Array.add(xb.controls,this.VDf(dc));
Array.add(rc.sections,xb);Array.add(Rb,{["type"]:"AppFlyoutAnchorProps",["id"]:"mandatoryLabelling_"+Wb.Id,["label"]:Wb.DisplayName,["hideLabel"]:!1,["hideChevron"]:!1,["hideIcon"]:!1,["menuDefinition"]:rc})}else Array.add(Rb,this.VDf(Wb))}return Rb}NNa(Rb,dc,$a,Wb,rc){if(1===$a||!this.$l.value.Bea(!0))return 32;rc.MenuItems=Object.assign(new Z.a,{Id:"SensitivityList",MenuSectionList:[],UpdateDynamically:!0});Array.add(rc.MenuItems.MenuSectionList,this.ji(!this.isReactRibbonEnabled()));this.rm.CustomUrl&&
Array.add(rc.MenuItems.MenuSectionList,this.h7h(this.isReactRibbonEnabled()?this.rm.CustomUrl:Xa.a.om(this.rm.CustomUrl)));this.isReactRibbonEnabled()||(rc.PopulationXML=Va.q(rc.MenuItems));return 32}kub(Rb,dc,$a,Wb,rc){if(1===$a||!rc||!this.JFc)return 32;za(this.Ha)||(this.Hda=this.$l.value.Nn);if(this.$l.value.Bea(!0)&&(rc[k.visible]=!0,this.oQe||(ea.a("MipLabelsAvailable"),this.oQe=!0),this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelTUIEnabled",!1)&&this.rm.AreLabelsAvailable&&
(Rb=Object(U.a)()))){let xb;xb=za(this.Ha)?this.rm.AppliedPolicyId?"LouderLabel_LabelExistsOnLoadActivity":"LouderLabel_NoLabelAppliedOnLoadActivity":Da.Gm(this.rm.AppliedPolicyId)?"LouderLabel_NoLabelAppliedOnLoadActivity":"LouderLabel_LabelExistsOnLoadActivity";Rb.execute(ic=>{ic.logActivity(xb,null)})}return 32}u7(Rb,dc,$a,Wb,rc){if(1===$a||!rc)return 32;let xb,ic;rc[k.Y0g]=!!(xb=rc[k.menuItemId])&&!!(ic=this.mEb[xb])&&ic===this.rm.AppliedPolicyId;return 32}Xba(Rb,dc,$a,Wb,rc){if(1===$a||!rc)return 32;
let xb,ic,Rc;Rb=!!(xb=rc[k.gF])&&!!(ic=this.mEb[xb])&&!!(Rc=this.U4a[ic])&&Rc.contains(this.rm.AppliedPolicyId);rc[k.nyi]=Rb;rc[k.Y0g]=Rb;return 32}setSensitivity(Rb,dc,$a,Wb,rc){if(1===$a||!rc)return 32;Rb=this.mEb[rc[k.gF]];ea.a("SensitivityPickerUsage",void 0,void 0,[{name:"SensitivityPickerLocation",int64:this.Y3k(rc[k.X3k])}]);return this.N7a(Rb,rc,2)}uGc(){return!!r.AFrameworkApplication.ra&&1===r.AFrameworkApplication.ra.mode}X1g(){this.rm.DefaultLabelId&&this.rm.MandatoryLabelingEnforced?
this.Z9c||this.uGc()?this.rm.AppliedPolicyId?this.nEd(""):(this.$l.value.Xpj(this.$l.value.EYb)||this.uGc())&&this.Etf():this.IOg():this.rm.DefaultLabelId?this.IOg():this.rm.MandatoryLabelingEnforced&&(this.rm.AppliedPolicyId?this.nEd(""):this.Etf())}o0f(){return this.rm.MandatoryLabelingEnforced?this.rm&&this.rm.AreLabelsAvailable?this.Ha.ka("TestOverrideIsReactDialogEnabled")||this.Km&&this.Km.$g&&this.Km.$g.VM?!0:(E.ULS.sendTraceTag(539109065,306,50,"Mandatory labelling not invoked b/c react dialogs disabled!"),
!1):(E.ULS.sendTraceTag(539109064,306,50,"Mandatory labelling not invoked b/c there are no sensitivity labels!"),!1):(E.ULS.sendTraceTag(539109063,306,50,"Mandatory labelling not invoked b/c user did not have policy!"),!1)}Etf(){!this.o0f()||r.AFrameworkApplication.cha||this.$Re||(this.$Re=r.AFrameworkApplication.cha=!0,E.ULS.sendTraceTag(562837517,306,50,"Mandatory labelling is invoked successfully."),this.$l.value.zzg("",1),this.$l.value.Snd(37,Object(S.a)("MandatoryLabellingDialogBusinessBarTitle"),
Object(S.a)("MandatoryLabellingDialogDescriptionText"),Object(S.a)("MandatoryLabellingDialogBusinessBarButton"),()=>{this.RDj()}))}nEd(Rb){this.o0f()&&r.AFrameworkApplication.cha&&(r.AFrameworkApplication.cha=!1,E.ULS.sendTraceTag(562837518,306,50,"Mandatory labelling is escaped successfully."),this.$l.value.iie(),this.$l.value.zzg(Rb,2))}RDj(){V.instance.t7h(this.APi(),this.rm.CustomUrl,this.SDj)}z$e(){return this.Ha.ka("CoAuthForProtectedFilesEnabled")&&this.Ha.ka("SupportsOfficeClientCoauthoring")&&
this.Ha.ka("SetPolicyLabelAwaitFileExistsOnHostIsEnabled")&&!!this.OLe&&this.kLa}N7a(Rb,dc,$a){this.$l.value.ddk($a);let Wb=32,rc=!1,xb=!0;const ic=this.FC[Rb],Rc=2===$a||8===$a||16===$a,Zc=Rb===this.rm.AppliedPolicyId;if(this.Y7c&&this.Y7c(Rb,Rc))E.ULS.sendTraceTag(42860829,306,15,"SetSensitivity : As app doesn't support changing the label, skipping SetSensitivity call. ApplyLabelFlag : {0}",$a),this.Km.UB();else if(dc&&k.zqd in dc&&this.$l.value.LEk(dc[k.zqd]),Rb)if(this.$l.value.L2f()||this.z$e()&&
this.Vdd)E.ULS.sendTraceTag(42796168,306,50,"Policy label cannot be set because a set policy label request is already in progress. ApplyLabelFlag: {0}",$a),this.Km.UB(),Rc&&this.Xmc(Object(S.a)("SensitivityApplicationDialogErrorTitle"),Object(S.a)("SensitivityQuickApplicationErrorMessage"));else if(this.Ha.ka("HasDocumentEditRights"))if(this.$l.value.ITh(Rb))if((za(this.Ha)?null===ic||void 0===ic?0:ic.HasUserDefinedPermissions:this.k3[Rb]&&this.k3[Rb].HasUserDefinedPermissions)&&!Zc)E.ULS.sendTraceTag(540608323,
306,50,"UDP label cannot be applied during UDP in WAC Phase 1. ApplyLabelFlag: {0}",$a),1!==$a&&4!==$a&&this.zGh();else if(Rc&&this.rm.MandatoryLabelingEnforced&&Zc)E.ULS.sendTraceTag(570972054,306,50,"Policy label cannot be removed due to mandatory labeling. ApplyLabelFlag: {0}",$a),this.Xmc(Object(S.a)("MandatoryLabellingBlockLabelRemovalDialogTitle"),Object(S.a)("MandatoryLabellingBlockLabelRemovalDialogDescriptionText"));else{if(Rc&&this.Ha.ka("WacLabelingJustificationDialogIsEnabled")&&this.rm.RequiredDowngradeJustification&&
(Zc||(za(this.Ha)?null===ic||void 0===ic?0:ic.RequiredDowngradeJustification:this.k3[Rb].RequiredDowngradeJustification))&&!this.rEa)return E.ULS.sendTraceTag(570972055,306,50,"Downgrade justification is required. ApplyLabelFlag: {0}",$a),this.ite(Rb),Wb;if(this.z$e()&&!this.OLe())this.J7c<this.Vhh?(E.ULS.sendTraceTag(577356770,306,50,"File does not exist on host, retrying after delay. RetryCount: {0} ApplyLabelFlag: {1}",this.J7c,$a),this.Vdd=!0,this.J7c++,x.Task.delay(this.Whh).continueWith(()=>
{this.Vdd=!1;this.N7a(Rb,dc,$a)})):(E.ULS.sendTraceTag(577356771,306,15,"Policy label cannot be set because maximum retries were reached checking for file existence. ApplyLabelFlag: {0}",$a),rc=1!==$a,xb=!1,Wb=8);else{if(this.uoj(Rb)&&(E.ULS.sendTraceTag(553911752,306,15,"Policy label cannot be set because the selected label is a parent label. ApplyLabelFlag: {0}",$a),1===$a||8===$a||4===$a))return Wb;E.ULS.sendTraceTag(570972056,306,50,"SetSensitivityByPolicyId is succeeded. ApplyLabelFlag: {0}",
$a);this.Kwb(Zc?"":Rb,this.rEa,$a);return Wb}}else E.ULS.sendTraceTag(42796169,306,50,"Policy label cannot be set because the user is in a coauth session. ApplyLabelFlag: {0}",$a),this.Km.UB(),Rc&&this.Xmc(Object(S.a)("SensitivityApplicationDialogErrorTitle"),Object(S.a)("SensitivityCoauthApplicationErrorMessage"));else E.ULS.sendTraceTag(558892739,306,50,"Policy label cannot be set because the user doesn't have edit rights. ApplyLabelFlag: {0}",$a),this.Km.UB(),Rc&&this.Xmc(Object(S.a)("SensitivityApplicationDialogErrorTitle"),
Object(S.a)("SensitivityNoEditRightsErrorMessage"));else E.ULS.sendTraceTag(42796167,306,15,"Policy label cannot be set because the selected policy ID is null. ApplyLabelFlag: {0}",$a),this.Km.UB(),rc=Rc,xb=!1,Wb=8;this.$l.value.Ffe(0,$a,rc,xb);return Wb}pod(Rb){Rb.forEach(dc=>{this.LGb.set(dc.watermarkElement,dc)});this.zIh(Rb);return{}}afb(Rb,dc,$a=null,Wb=!1){db.Health.instance.recordKpiUsage("MipAutoClassificationSetLabel",Ea.b.FailureBased,"wordclpfc",null);this.Ha.ka("SupportsOfficeClientCoauthoring")&&
this.Ha.ka("CoAuthForProtectedFilesIsEnabled")?(this.wDb=!1,za(this.Ha)||(this.Hda=this.$l.value.Nn),this.rm&&!this.rm.AppliedPolicyId?this.wDb=!0:this.rm&&this.rm.PolicyLabelAssignmentMethod&&(this.wDb=Sa.e(this.rm.PolicyLabelAssignmentMethod)===Sa.e("standard"))):this.wDb=Wb;za(this.Ha)?(Rb=Rb?this.FC[Rb]:null,dc=dc?this.FC[dc]:null):(Rb=Da.Gm(Rb)?null:this.k3[Rb],dc=Da.Gm(dc)?null:this.k3[dc]);dc?this.Kka=new O(dc,!0,$a):(this.$l.value.dqa(29),this.Sra=null);Rb?this.nDa=new O(Rb,!1):this.qab=null;
this.Bee(null,null);return 32}IIh(Rb){""!==this.rm.AppliedPolicyId?this.$l.value.Ffe(14,16,!0):this.N7a(Rb,null,16)}CPg(){this.k3={};za(this.Ha)||(this.Hda=this.$l.value.Nn);if(this.rm)for(const Rb of this.rm.SensitivityLabels)this.k3[Rb.Id]=Rb}uoj(Rb){if(!za(this.Ha)&&!this.TEa)return!1;if(Rb in this.U4a){Rb=this.U4a[Rb];for(const dc of Rb)if((Rb=this.FC[dc])&&Rb.Enabled)return!0}return!1}qQg(){this.TEa={};za(this.Ha)||(this.Hda=this.$l.value.Nn);if(this.rm){for(const Rb of this.rm.SensitivityLabels)Rb.ParentId||
(this.TEa[Rb.Id]=new K.a);for(const Rb of this.rm.SensitivityLabels)this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)?Rb.ParentId&&Rb.ParentId in this.TEa&&(this.k3[Rb.ParentId]&&(Rb.ParentName=this.k3[Rb.ParentId].DisplayName),Rb.Enabled&&this.TEa[Rb.ParentId].add(Rb.Id)):Rb.ParentId&&Rb.ParentId in this.TEa&&Rb.Enabled&&this.TEa[Rb.ParentId].add(Rb.Id)}}Qyg(){za(this.Ha)||(this.Hda=this.$l.value.Nn);const Rb=this.JFc&&this.isReactRibbonEnabled()&&
this.$l.value.Bea();Da.iVc(Rb)}Zgk(Rb){this.Y7c=Rb}Shk(Rb){this.Rdd=Rb}IOg(){if(this.Ha.ka("WacApplyDefaultPolicyLabelIsEnabled"))if(this.uGc())this.Bdd=!0;else if(!this.Z9c&&(this.Z9c=!0,za(this.Ha)||(this.Hda=this.$l.value.Nn),this.rm&&this.rm.DefaultLabelId))if(!this.rm.AppliedPolicyId)E.ULS.sendTraceTag(509732190,306,50,"Default labeling triggered. DefaultLabelType: {0}",this.rm.DefaultLabelType),this.N7a(this.rm.DefaultLabelId,null,1);else if(M.a.zm().equals(this.rm.DefaultLabelType,"documentLibraryDefault")){const Rb=
this.FC[this.rm.AppliedPolicyId],dc=this.FC[this.rm.DefaultLabelId];this.rm.AppliedPolicyId!==this.rm.DefaultLabelId&&M.a.zm().equals(this.rm.PolicyLabelAssignmentMethod,"standard")&&Rb.Order<dc.Order&&(E.ULS.sendTraceTag(509732189,306,50,"Default labeling triggered. DefaultLabelType: {0}",this.rm.DefaultLabelType),this.N7a(this.rm.DefaultLabelId,null,1))}}h1a(){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarking",!1)||this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",
!1)}Kwb(Rb,dc,$a=2){this.rEa=dc;this.h1a()&&this.Whe();this.$l.value.Kwb(Rb);this.Km.UB();dc=this.FC[Rb];const Wb=za(this.Ha)?this.$l.value.kna(dc):this.kna(dc);$a=new R($a,Wb);this.h1a()&&this.Bnc(dc,Array.from(this.LGb.values()));this.$l.value.rYc(Rb,this.rEa,$a)}$Vd(Rb){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Microsoft FTE"===Rb.DisplayName:Rb.AppliesDynamicWatermarking}TKd(Rb){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",
!1)?"Watermark Text":Rb.DynamicWatermarkingText}eAg(Rb){if(null!==Rb&&this.$Vd(Rb)){Rb=this.TKd(Rb);var dc=Object(S.a)("WatermarkTextScreenReaderTemplate");dc=void 0!==dc?dc.replace(/\{0\}/g,Rb):Rb;this.RDb!==dc&&(this.RDb=dc,this.hh.raiseEvent("watermarkChangeHandlerEventKey",new ma(dc)))}else this.RDb=""}Whe(){ya.c()&&(E.ULS.sendTraceTag(507348994,306,50,"Remove Watermark is invoked successfully"),appChrome.removeWatermark(),this.eAg(null))}zIh(Rb){this.FC&&this.rm.AppliedPolicyId?this.Bnc(this.FC[this.rm.AppliedPolicyId],
Rb):E.ULS.sendTraceTag(507348993,306,15,"Watermark is not applied as sensitivity label is not available.")}Bnc(Rb,dc){Rb?this.$l.value.$Vd(Rb)&&ya.c()&&(E.ULS.sendTraceTag(507348963,306,50,"Apply Watermark is invoked successfully"),appChrome.applyWatermark(dc,this.$l.value.TKd(Rb)),this.eAg(Rb)):E.ULS.sendTraceTag(507348992,306,15,"Watermark is not applied as sensitivity label is not available.")}ite(Rb){(new C(Rb,this.W1h)).ite()}Xmc(Rb="",dc=""){const $a=new va.a;$a.BC=r.AFrameworkApplication.nVb;
$a.Ph=0;$a.ri(1,Object(S.a)("DialogClose"));$a.iW(Rb,dc,null)}zGh(){const Rb=new va.a;Rb.BC=r.AFrameworkApplication.nVb;Rb.Ph=1;Rb.ri(1,Object(S.a)("OICDownLoadACopyDialogOpenButton"));Rb.ri(0,Object(S.a)("DialogClose"));Rb.iW(Object(S.a)("SensitivityApplicationDialogErrorTitle"),Object(S.a)("SensitivityBlockUDPSetLabelMessage"),this.YMh)}isReactRibbonEnabled(){return!!this.Km&&!!this.Km.$g&&this.Km.$g.Oq}Mo(){return this.Km&&this.Km.$g?this.Km.$g.Mo:!1}KFk(Rb,dc,$a,Wb){Rb?(Wb[k.value]=Rb,Wb[k.yo]=
Rb,Wb[k.customTooltip]=dc,this.KPg($a,r.AFrameworkApplication.protectedFile,Wb)):(Wb[k.iconColor]=k.U1c,this.rm.MandatoryLabelingEnforced?(Wb[k.value]=Wb[k.yo]=this.vBc().Cne,Wb[k.icon]=k.iek):(Wb[k.value]=Wb[k.yo]=this.vBc().o7d,Wb[k.icon]=k.lek));Wb[k.visible]=!0}zEk(Rb){let dc="",$a="",Wb="";if(this.rm.AreLabelsAvailable){let rc=null;this.FC&&(rc=this.FC[this.rm.AppliedPolicyId]);let xb="";this.h1a()&&(xb=this.RDb,this.Whe());rc&&(this.h1a()&&(this.RDb=xb,this.Bnc(rc,Array.from(this.LGb.values()))),
dc=za(this.Ha)?this.$l.value.kna(rc):this.kna(rc),$a=rc.Tooltip,this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)||(r.AFrameworkApplication.protectedFile=this.$l.value.soa(rc)),Wb=this.kKd(rc));if(!this.$l.value.Bea()&&!rc)return}else{if(this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.TitleBarSensitivityBufferEnabled",!1))dc=this.rsa?this.rsa:"";else{if(!this.rsa)return;dc=this.rsa}Wb=k.U1c;$a=this.HDb?this.HDb:""}this.KFk(dc,$a,Wb,Rb)}jub(Rb,
dc,$a,Wb,rc){if(1===$a)return 32;za(this.Ha)||(this.Hda=this.$l.value.Nn);if(!this.rm||!rc)return 32;rc[k.value]="";rc[k.yo]="";rc[k.alt]=null;rc[k.QTf]=null;rc[k.Ina]=null;rc[k.customTooltip]="";rc[k.visible]=!1;rc[k.iconColor]="";rc[k.icon]="";if(this.sXd())this.zEk(rc);else{$a=dc=Rb="";if(!this.rm.AreLabelsAvailable){if(!this.rsa)return 32;Rb=this.rsa;$a=k.U1c;this.HDb&&(dc=this.HDb)}else if(this.rm.AppliedPolicyId){Wb=null;for(const xb of this.rm.SensitivityLabels)if(xb.Id.toLowerCase()===this.rm.AppliedPolicyId.toLowerCase()){Wb=
xb;break}this.h1a()&&this.Whe();Wb&&(this.h1a()&&this.Bnc(Wb,Array.from(this.LGb.values())),Rb=za(this.Ha)?this.$l.value.kna(Wb):this.kna(Wb),dc=Wb.Tooltip,this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)||(r.AFrameworkApplication.protectedFile=this.$l.value.soa(Wb)),$a=this.kKd(Wb))}Rb&&(rc[k.value]=Rb,rc[k.yo]=Rb,this.Mo()?rc[k.customTooltip]=dc:rc[k.alt]=dc,this.KPg($a,r.AFrameworkApplication.protectedFile,rc),rc[k.visible]=!0)}return 32}q3b(Rb,
dc,$a,Wb,rc){if(1===$a)return 32;za(this.Ha)||(this.Hda=this.$l.value.Nn);if(!this.rm||!rc)return 32;rc[k.yo]="";if(this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpUseHideBarByDefaultSetting",!1)&&this.rm.HideBarByDefault)return 32;Rb="";if(this.rm.AreLabelsAvailable)if(this.rm.AppliedPolicyId){if(!this.FC)return 32;(dc=this.FC[this.rm.AppliedPolicyId])&&(Rb=dc.ParentId&&this.FC[dc.ParentId]?za(this.Ha)?dc.ParentName:this.FC[dc.ParentId].DisplayName:dc.DisplayName)}else Rb=this.rm.MandatoryLabelingEnforced?
this.vBc().Cne:this.vBc().o7d;else{if(!this.rsa)return 32;Rb=this.rsa}rc[k.yo]=Rb;return 32}kna(Rb){return Rb?this.k3?Rb.ParentId&&this.k3[Rb.ParentId]?this.k3[Rb.ParentId].DisplayName+"\\"+Rb.DisplayName:Rb.DisplayName:(E.ULS.sendTraceTag(4282E4,306,15,"Policy ID to Sensitivity label dictionary has not been initialized."),Rb.DisplayName):""}KPg(Rb,dc,$a){this.sXd()?($a[k.icon]=this.CMf(dc),$a[k.iconColor]=this.DMf(Rb)):this.Mo()?$a[k.icon]=dc?k.ZUk:k.bVk:($a[k.QTf]=r.AFrameworkApplication.JE,$a[k.Ina]=
dc?ja.c(k.$Uk):ja.c(k.cVk))}h7h(Rb){const dc=this.a0("LearnMoreSection",!0);Rb=Object.assign(new la.a,{Id:"SensitivityLearnMore",ExternalId:"SensitivityLearnMore",MenuItemId:Rb,LabelText:Object(S.a)("LearnMore"),Command:za(this.Ha)?m.a.openUrlInNewTab.toString():"1959943459",Image16by16:r.AFrameworkApplication.JE,Image16by16Class:ja.c(k.iwj),Visible:!0,Alt:Object(S.a)("LearnMoreTooltip"),KeyTip:"L"});Array.add(dc.ControlList,Rb);return dc}Cmf(Rb,dc,$a=!1){let Wb;Wb="Toggle_"+Rb.Id;Wb="Sensitivity_"+
Wb;const rc=Rb.DisplayName,xb=Rb.Tooltip;var ic=Rb.Id===this.rm.AppliedPolicyId,Rc=$a?Xa.a.om(Wb):Wb;this.sXd()?(ic=this.kKd(Rb),dc=Object.assign(new Qa.a,{Id:Rc,ExternalId:Rc,LabelText:$a?Xa.a.om(rc):rc,Command:za(this.Ha)?m.a.setSensitivity.toString():"2935633379",MenuItemId:Rc,QueryCommand:za(this.Ha)?m.a.u7.toString():"991261903",Visible:!0,Alt:$a?Xa.a.om(xb):xb,AriaLabel:Ia.a.Snc,IconColor:this.DMf(ic),KeyTip:dc}),dc.ExternalImageId=this.CMf(this.$l.value.soa(Rb))):(Rc=Object.assign(new X.a,
{Id:Rc,ExternalId:Rc,LabelText:$a?Xa.a.om(rc):rc,Command:za(this.Ha)?m.a.setSensitivity.toString():"2935633379",MenuItemId:Rc,QueryCommand:za(this.Ha)?m.a.u7.toString():"991261903",CheckedImage:r.AFrameworkApplication.JE,Visible:!0,Alt:$a?Xa.a.om(xb):xb,IsChecked:ic,AriaLabel:Ia.a.Snc,KeyTip:dc}),this.isReactRibbonEnabled()?(Rc.CheckedImageClass=ja.c(k.Ufe),Rc.ExternalImageId=k.Ufe):Rc.CheckedImageClass=ja.c(k.LKb),dc=Rc);Rc=Wb;this.mEb[Rc]=Rb.Id;this.cVe[Rb.Id]=Rc;return dc}a0(Rb,dc=!1){return Object.assign(new ba.a,
{Title:"",Id:Rb,DisplayMode:k.menu,ShowMenuSectionSeparator:dc,ControlsId:"Ctrl_"+Rb,ControlList:[]})}o$h(Rb,dc,$a){Rb=this.a0(Rb+"Sub");let Wb=1;for(const rc of dc)(dc=this.FC[rc])&&dc.Enabled&&(Array.add(Rb.ControlList,this.Cmf(dc,Wb.toString(),$a)),Wb++);return Rb}ji(Rb=!1){const dc=this.a0("SensitivitySection");let $a=1;for(const Wb in this.U4a){const rc=this.U4a[Wb],xb=this.FC[Wb];if(xb&&xb.Enabled){if(rc.count){const ic="Label"+this.Hjh++,Rc=Object.assign(new na.a,{Id:ic,ExternalId:ic,LabelText:Rb?
Xa.a.om(xb.DisplayName):xb.DisplayName,Command:za(this.Ha)?m.a.alwaysEnabled.toString():"798637440",QueryCommand:za(this.Ha)?m.a.Xba.toString():"2875864574",Menu:Object.assign(new Z.a,{Title:"",MenuSectionList:[],UpdateDynamically:!0}),ImageIsVisible:!1,Toggled:!1,ImageUsesSpaceWhileInvisible:!0,AriaLabel:Ia.a.Snc,KeyTip:$a.toString(),Alt:Rb?Xa.a.om(xb.Tooltip):xb.Tooltip});this.isReactRibbonEnabled()?Rc.ExternalImageId=k.Ufe:(Rc.Image16by16=r.AFrameworkApplication.JE,Rc.Image16by16Class=ja.c(k.LKb));
Array.add(Rc.Menu.MenuSectionList,this.o$h(ic,rc,Rb));Array.add(dc.ControlList,Rc);this.mEb[Rc.Id]=xb.Id;this.cVe[xb.Id]=Rc.Id}else Array.add(dc.ControlList,this.Cmf(xb,$a.toString(),Rb));$a++}}return dc}SGb(Rb){return!!this.$f.aY(Rb)&&!!this.$f.aY(Rb).flags&&!!this.$f.aY(Rb).flags.length}CMf(Rb){return Rb?k.kek:k.jek}DMf(Rb){return Rb?Rb:k.U1c}kKd(Rb){if(Rb.Color||!Rb.ParentId)return Rb.Color;const dc=this.FC[Rb.ParentId];return dc?dc.Color:Rb.Color}Y3k(Rb){switch(Rb){case 2:case 14:case 15:return 1;
case 21:return 2;default:return 0}}vBc(){this.thd||(this.thd=Object.assign(new J,{o7d:HeaderStrings.NoSensitivityLabel,Cne:HeaderStrings.SelectASensitivityLabel}));return this.thd}static Q9k(){r.AFrameworkApplication.fa&&!r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelEnabled",!1)||!ya.c()||appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("OpenDocumentLabelPane",!0))}static iVc(Rb){ya.c()&&appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("Sensitivity",
!Rb))}static Gm(Rb){return Rb&&Rb.length?!1:!0}}Object(h.a)(Da,"PolicyActor",null,[589]);var Ua=a(768),ka=a(1264),xa;(function(Rb){Rb[Rb.unknown=0]="unknown";Rb[Rb.Ikl=1]="boot";Rb[Rb.refresh=2]="refresh";Rb[Rb.eul=3]="selfSetPolicyLabel"})(xa||(xa={}));Object(h.b)("GetPolicyLabelsReason",xa);class Fb extends Sys.EventArgs{constructor(Rb,dc,$a,Wb,rc,xb){super();this.PJb=Rb;this.title=dc;this.message=$a;this.buttonText=Wb;this.Ela=rc;this.XWb=xb}}Object(h.a)(Fb,"AddAutoPolicyBusinessBarEntryEventArgs",
Sys.EventArgs,[]);class bb extends Sys.EventArgs{constructor(Rb,dc,$a,Wb,rc){super();this.PJb=Rb;this.title=dc;this.message=$a;this.buttonText=Wb;this.Ela=rc}}Object(h.a)(bb,"AddMandatoryLabellingBusinessBarEntryEventArgs",Sys.EventArgs,[]);var Ja;(function(Rb){Rb[Rb.none=0]="none";Rb[Rb.reasonDefaultLabel=1]="reasonDefaultLabel";Rb[Rb.reasonManual=2]="reasonManual";Rb[Rb.reasonAutomatic=4]="reasonAutomatic";Rb[Rb.reasonRecommended=8]="reasonRecommended";Rb[Rb.reasonMandatory=16]="reasonMandatory";
Rb[Rb.reasonAI=32]="reasonAI"})(Ja||(Ja={}));Object(h.b)("ApplyLabelFlags",Ja);class mb extends Sys.EventArgs{constructor(Rb,dc,$a){super();this.ygf=Rb;this.xgf=dc;this.existingLabelPriority=$a}}Object(h.a)(mb,"AutoCLPSecurityNodesEventArgs",Sys.EventArgs,[]);class sa extends Sys.EventArgs{constructor(){super()}}Object(h.a)(sa,"GetPolicyLabelEventArgs",Sys.EventArgs,[]);class oa extends Sys.EventArgs{constructor(){super()}}Object(h.a)(oa,"GetPolicyLabelFailureEventArgs",Sys.EventArgs,[]);var cb=a(1354),
Ka=a(1153);class Oa extends Sys.EventArgs{constructor(Rb=!1,dc=null,$a=null,Wb=null){super();this.H1=Rb;this.ync=dc;this.context=$a;this.vQg=Wb}}Object(h.a)(Oa,"LabelInfoUpdateEventArgs",Sys.EventArgs,[]);class gb extends Sys.EventArgs{constructor(Rb,dc){super();this.sMa=Rb;this.j7e=dc}}Object(h.a)(gb,"MandatoryLabellingAppHandlerEventArgs",Sys.EventArgs,[]);class bc extends Sys.EventArgs{constructor(Rb,dc,$a,Wb){super();this.title=Rb;this.HRc=dc;this.buttonText=$a;this.Ihg=Wb}}Object(h.a)(bc,"PolicyTipEventArgs",
Sys.EventArgs,[]);class Dc extends Sys.EventArgs{constructor(Rb,dc){super();this.PJb=Rb;this.XWb=dc}}Object(h.a)(Dc,"RemoveAutoPolicyBusinessBarEntryEventArgs",Sys.EventArgs,[]);class ad extends Sys.EventArgs{constructor(){super()}}Object(h.a)(ad,"RemoveMandatoryLabellingBusinessBarEntryEventArgs",Sys.EventArgs,[]);class Ac extends Sys.EventArgs{constructor(Rb,dc){super();this.GRc=Rb;this.tX=dc}}Object(h.a)(Ac,"SetPolicyLabelEventArgs",Sys.EventArgs,[]);class mc extends Sys.EventArgs{constructor(Rb,
dc,$a,Wb=null,rc=null,xb=null,ic=null){super();this.errorType=Rb;this.fVg=$a;this.title=Wb;this.message=rc;this.buttonText=xb;this.Ela=ic}}Object(h.a)(mc,"SetPolicyLabelFailureEventArgs",Sys.EventArgs,[]);class Gb extends Sys.EventArgs{constructor(){super()}}Object(h.a)(Gb,"SetPolicyLabelTriggeredEventArgs",Sys.EventArgs,[]);class Ba extends Sys.EventArgs{constructor(Rb){super();this.ALk=Rb}}Object(h.a)(Ba,"UDPLabelingAppHandlerEventArgs",Sys.EventArgs,[]);var Xb=a(1356),Ab=a(124),Db=a(97),xc=a(47),
vc=a(59),zb=a(1355),tb=a(245);class ab{static gDk(Rb,dc){if(!Rb||!dc||Rb.count!==dc.count)return!1;for(const $a of Rb)if(!dc.contains($a))return!1;return!0}static toArray(Rb){if(!Rb)return null;const dc=Array(Rb.count);let $a=0;for(const Wb of Rb)dc[$a]=Wb,$a++;return dc}}Object(h.a)(ab,"HashSetUtils",null,[]);var La=a(225),pb=a(89);class ia{constructor(Rb,dc,$a,Wb=0,rc=null){this.W9c=this.dLe=null;this.jFa=this.JCb=this.LCb=0;this.IRa="";this.cUa=this.B7c=this.DOe=this.jDa=this.dfd=null;this.ePe=
!1;this.z7c=this.R5f=null;this.Jbd=0;this.Yhc=this.eUa=this.OSa=this.Xhc=null;this.hh=new qa.a;this.v7b=this.cSb=this.iw=null;this.Dcd=!1;this.VW={};this.QEb={};this.EYb=null;this.Ha=Rb;this.Yn=dc;this.Io=$a;this.Vgc=Wb;this.Nn=new cb.a;this.n3g();this.bVe=this.Ha.Za("PolicyHandlerEndpointName")||"PolicyHandler.ashx";this.b_=rc;this.JFc=Rb.ka("WacApplyManualPolicyLabelIsEnabled");this.ZFc=Rb.ka("CoAuthForProtectedFilesIsEnabled");this.supportsOfficeClientCoauthoring=Rb.ka("SupportsOfficeClientCoauthoring");
this.Tqj=!1;this.AFk=3E4;this.Fk=Db.TaskManager.instance;Rb.ka("SupportsPolicies")&&ea.a("MipSupportsPolicies");this.ZFc&&this.supportsOfficeClientCoauthoring&&ea.a("MipSupportsOfficeClientCoauthoring")}get hXf(){return this.Dcd}get iC(){var Rb,dc;return this.Vx()?null!==(dc=null===(Rb=this.Nn)||void 0===Rb?void 0:Rb.AppliedPolicyId)&&void 0!==dc?dc:"":this.IRa}get a8i(){if(this.Vx()){let Rb=0;for(const dc of this.Nn.SensitivityLabels)dc&&dc.Enabled&&(Rb=Math.max(Rb,dc.Order));return Rb}return this.Jbd}Y6b(Rb){this.Nn.AppliedPolicyId=
Rb;const dc=this.Ha.appSettings;dc&&(dc.AppliedPolicyId=Rb)}get $eb(){var Rb,dc,$a,Wb;if(this.Vx()){const rc=this.iC;return rc?this.Vx()?null!==(dc=null===(Rb=this.VW[rc])||void 0===Rb?void 0:Rb.Order)&&void 0!==dc?dc:null:null!==(Wb=null===($a=this.rlb(rc))||void 0===$a?void 0:$a.Order)&&void 0!==Wb?Wb:null:null}return this.z7c}Kwb(Rb){this.Vx()||(this.Nn.AppliedPolicyId=Rb,this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpSetCachedAppliedLabelId",!1)&&(this.IRa=Rb,this.o6g()))}N4e(Rb){this.hh.addHandler("PolicyTipEvent",
Rb)}RHb(Rb){this.hh.addHandler("LabelInfoUpdateEvent",Rb)}Pmk(Rb){this.hh.removeHandler("LabelInfoUpdateEvent",Rb)}X4e(Rb){this.hh.addHandler("SetPolicyLabelEventKey",Rb)}iok(Rb){this.hh.removeHandler("SetPolicyLabelEventKey",Rb)}vpd(Rb){this.hh.addHandler("SetPolicyLabelFailureEventKey",Rb)}hok(Rb){this.hh.removeHandler("SetPolicyLabelFailureEventKey",Rb)}yCh(Rb){this.hh.addHandler("GetPolicyLabelEventKey",Rb)}xCh(Rb){this.hh.addHandler("GetPolicyLabelFailureEventKey",Rb)}vCh(Rb){this.hh.addHandler("GetAutoPolicyLabelEventKey",
Rb);this.hXf&&(E.ULS.sendTraceTag(51668058,306,15,"GetAutoPolicyLabelHandler was registered after the AutoPolicyLabelHandlerEvent was raised"),this.ufe(new sa(0)))}nmk(Rb){this.hh.removeHandler("GetAutoPolicyLabelEventKey",Rb)}RBh(Rb){this.hh.addHandler("CreateAutoCLPSecurityNodesEventKey",Rb)}Plk(Rb){this.hh.removeHandler("CreateAutoCLPSecurityNodesEventKey",Rb)}SEh(Rb){this.hh.addHandler("UpdateAutoCLPLabelPriorityNodeEventKey",Rb)}sok(Rb){this.hh.removeHandler("UpdateAutoCLPLabelPriorityNodeEventKey",
Rb)}TEh(Rb){this.hh.addHandler("UpdateAutoCLPSITNodesEventKey",Rb)}tok(Rb){this.hh.removeHandler("UpdateAutoCLPSITNodesEventKey",Rb)}G3e(Rb){this.hh.addHandler("AddAutoPolicyBusinessBarEntryEventKey",Rb)}blk(Rb){this.hh.removeHandler("AddAutoPolicyBusinessBarEntryEventKey",Rb)}O4e(Rb){this.hh.addHandler("RemoveAutoPolicyBusinessBarEntryEventKey",Rb)}Nnk(Rb){this.hh.removeHandler("RemoveAutoPolicyBusinessBarEntryEventKey",Rb)}H3e(Rb){this.hh.addHandler("AddMandatoryLabellingBusinessBarEntryEventKey",
Rb)}dlk(Rb){this.hh.removeHandler("AddMandatoryLabellingBusinessBarEntryEventKey",Rb)}P4e(Rb){this.hh.addHandler("RemoveMandatoryLabellingBusinessBarEntryEventKey",Rb)}Onk(Rb){this.hh.removeHandler("RemoveMandatoryLabellingBusinessBarEntryEventKey",Rb)}kDh(Rb){this.hh.addHandler("MandatoryLabellingAppHandlerEventKey",Rb)}Ymk(Rb){this.hh.removeHandler("MandatoryLabellingAppHandlerEventKey",Rb)}QEh(Rb){this.hh.addHandler("UDPLabelingAppHandlerEventKey",Rb)}rok(Rb){this.hh.removeHandler("UDPLabelingAppHandlerEventKey",
Rb)}fEk(){this.VW={};for(const Rb of this.Nn.SensitivityLabels)this.VW[Rb.Id]=Rb}rFk(){this.QEb={};for(const Rb of this.Nn.SensitivityLabels)Rb.ParentId||(this.QEb[Rb.Id]=new K.a);for(const Rb of this.Nn.SensitivityLabels)Rb.ParentId&&Rb.ParentId in this.QEb&&(this.VW[Rb.ParentId]&&(Rb.ParentName=this.VW[Rb.ParentId].DisplayName),Rb.Enabled&&this.QEb[Rb.ParentId].add(Rb.Id))}get hWd(){if(!this.dLe)return!1;for(const Rb of this.dLe.bml())if(!Rb.Capabilities||!Rb.Capabilities.SupportsClientIsMipTrusted)return!1;
return!0}get lqj(){return!!this.iw}oWh(){return this.DOe?this.DOe():!1}Ugk(Rb){this.B7c=Rb}SF(){return(new Date).getTime()}q6(){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)}jAc(){this.Io&&(this.Xhc=this.Io.Li("WebServiceCall","Call Get Policy Endpoint On Server"));var Rb=La.a.kva(1,1);const dc={["X-UsePFTPOP"]:this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.WACAADTokenInPolicyHandlerIsEnabled",!1)?"1":"0"};this.Ha.ka("SendHostAttributionInfoForPolicyLabelEnabled")?
(Rb=new zb.a(this.U2b("datalosspolicy"),1,null,dc,!0,2,null,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,Rb),this.Yn.send(Rb).ghe(Object(N.a)(this,this.ijg,"onDataLossPolicySuccessCallback"),Object(N.a)(this,this.hjg,"onDataLossPolicyFailureCallback"))):this.Yn.lv(this.U2b("datalosspolicy"),1,null,dc,!0,2,Object(N.a)(this,this.ijg,"onDataLossPolicySuccessCallback"),Object(N.a)(this,this.hjg,"onDataLossPolicyFailureCallback"),null);this.LCb++;E.ULS.sendTraceTag(25565151,
306,50,"Policy request is sent to server. The endpoint used is {0}. Policy call times: {1}.",this.bVe,this.LCb)}Cgk(){this.iRb(this.iC,2,this.jDa)}iRb(Rb,dc=0,$a=null,Wb=!1,rc=null){db.Health.instance.recordKpiUsage("MipGetPolicyLabel",Ea.b.FailureBased,"officewebclp",this.fLd(void 0,dc));this.cSb=this.SF();const xb=this.Zyd(dc);this.iAc(Rb,xb,$a,Wb,dc,rc);this.Vje(!0)}n3g(){const Rb=Object(Ka.b)();if(this.zPe=!!Rb)this.Nn=Rb}t1f(){this.n3g();return this.zPe}ijg(Rb){this.jvg();let dc="";({data:dc}=
this.Bye(Rb)).returnValue&&(E.ULS.sendTraceTag(25565153,306,50,"Request to get DataLossPrevention policy succeeded."),this.LCb=0,this.Io&&(this.Yhc=this.Io.Li("Task","Parse and Handle Get Policy Response")),this.g4j(dc),this.Yhc&&(this.Yhc.stop(),this.Yhc=null))}hjg(Rb){this.jvg();this.LCb<=this.Vgc?this.jAc():(E.ULS.sendTraceTag(25565154,306,15,"Request to get DataLossPrevention policy failed with error response: {0}.",Rb?Rb.data?Rb.data.L6a:null:null),this.LCb=0)}L2f(){return 0<this.jFa}rYc(Rb,
dc,$a=null,Wb=null){const rc=this.$yd($a),xb=this.Vx()?this.iC:"";this.Vx()&&this.Y6b(Rb);this.Jpe(Rb,dc,rc,$a,Wb,xb)}yqg(Rb,dc){this.eUa&&(this.eUa.stop(),this.eUa=null);const {JMg:$a,wQg:Wb,aF:rc}=this.ILf(Rb),xb=Rb.data.state,ic=xb?xb.tX:2;let Rc="";({data:Rc}=this.Bye(Rb)).returnValue?(E.ULS.sendTraceTag(41799707,306,50,"Request to set label policy data succeeded. ApplyLabelFlag: {0}",ic),this.jFa=0,this.B4j(Rc,$a,Wb,xb,rc,dc)):this.Ule(ic,rc,0,dc)}ddk(Rb){db.Health.instance.recordKpiUsage("MipSetPolicyLabel",
Ea.b.FailureBased,"officewebclp",this.fLd(Rb));this.v7b=this.SF();E.ULS.sendTraceTag(575947405,306,50,"Raising set policy label triggered event.");this.hh.raiseEvent("SetPolicyLabelTriggeredEventKey",new Gb(Rb))}LKj(){this.ZFc&&this.supportsOfficeClientCoauthoring&&this.lqj&&this.iw.Kia(12,null,!0)}xqg(Rb,dc){this.eUa&&(this.eUa.stop(),this.eUa=null);const {JMg:$a,wQg:Wb,aF:rc}=this.ILf(Rb);if(this.jFa<=this.Vgc)this.Vx()?this.Jpe($a,Wb,this.$yd(null),null,rc,dc):this.rYc($a,Wb,null,rc);else{var xb=
Rb.data.state;xb=xb?xb.tX:2;E.ULS.sendTraceTag(41799708,306,15,"Request to set label policy failed with error response: {0}. ApplyLabelFlag: {1}",Rb?Rb.data?Rb.data.L6a:null:null,xb);this.EYb="WACServerConnectionFailed";this.jFa=0;this.Ule(xb,rc,0,dc)}}Xpj(Rb){if(Rb&&("LabelNotSupported"===Rb||"LabelErrorRetryLater"===Rb||"CoherencyFailure"===Rb||"LabelIdNotFound"===Rb||"LabelDisabled"===Rb))return E.ULS.sendTraceTag(539103556,306,50,"LabelError is retriable: {0}",Rb),!0;E.ULS.sendTraceTag(539103557,
306,50,"LabelError is not retriable: {0}",Rb);return!1}soa(Rb){return Rb.IsEndpointProtectionEnabled||Rb.HasUserDefinedPermissions}$Vd(Rb){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Microsoft FTE"===Rb.DisplayName:Rb.AppliesDynamicWatermarking}TKd(Rb){return this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Watermark Text":Rb.DynamicWatermarkingText}ITh(Rb){if(!Rb)return!1;let dc=
null,$a=null;if(this.Vx())dc=this.VW[Rb],$a=this.VW[this.iC];else for(const Wb of this.Nn.SensitivityLabels)Wb.Id===Rb&&(dc=Wb),Wb.Id===this.iC&&($a=Wb);if(!dc)return!1;if(this.ZFc&&this.supportsOfficeClientCoauthoring){if(this.B7c&&this.B7c()||this.hWd)return!0}else if(r.AFrameworkApplication.FI&&r.AFrameworkApplication.FI.IQb||this.jDa&&this.jDa())return!0;return this.soa(dc)===(!!$a&&this.soa($a))}mHb(Rb,dc,$a,Wb,rc){28===Rb?this.dzg(new Fb(Rb,dc,$a,Wb,rc,!1)):this.dzg(new Fb(Rb,dc,$a,Wb,rc,!0))}dqa(Rb){28===
Rb?this.Ozg(new Dc(Rb,!1)):this.Ozg(new Dc(Rb,!0))}cck(Rb,dc,$a){E.ULS.sendTraceTag(545280777,306,50,"Raising a CreateAutoCLPSecurityNodes event.");this.hh.raiseEvent("CreateAutoCLPSecurityNodesEventKey",new mb(Rb,dc,$a))}jdk(Rb){E.ULS.sendTraceTag(545280778,306,50,"Raising a UpdateAutoCLPLabelPriorityNode event.");this.hh.raiseEvent("UpdateAutoCLPLabelPriorityNodeEventKey",new mb(null,null,Rb))}kdk(Rb,dc){E.ULS.sendTraceTag(545280779,306,50,"Raising a UpdateAutoCLPSITNodes event.");this.hh.raiseEvent("UpdateAutoCLPSITNodesEventKey",
new mb(Rb,dc,null))}zzg(Rb,dc){E.ULS.sendTraceTag(572650527,306,50,"Raising a mandatory labelling"+(1===dc?"Reading":"Edit")+" switch event.");this.hh.raiseEvent("MandatoryLabellingAppHandlerEventKey",new gb(Rb,dc))}Snd(Rb,dc,$a,Wb,rc){37===Rb&&this.Tbk(new bb(37,dc,$a,Wb,rc))}iie(){this.Xck(new ad)}idk(){E.ULS.sendTraceTag(540608322,306,50,"Raising a UDP labeling event.");this.hh.raiseEvent("UDPLabelingAppHandlerEventKey",new Ba(!0))}Bea(Rb=!1){const dc=Object(Xb.a)(this.Nn);dc||Rb||Da.iVc(!1);return dc}Kzk(){window.postMessage(JSON.stringify({type:"mipProperties",
isProtected:r.AFrameworkApplication.protectedFile,sensitivity:{labelId:this.iC},usageRights:{docEdit:this.Nn.EditEnabled,extract:r.AFrameworkApplication.enableExtractForProtectedFile,print:r.AFrameworkApplication.printingEnabled,export:r.AFrameworkApplication.bjb,objModel:r.AFrameworkApplication.enableMacrosForProtectedFile,owner:r.AFrameworkApplication.cjb}}),"*")}v7j(){E.ULS.shipAssertTag(507888257,306,this.t1f(),"populatePolicyLabelsDataFromCache was called with no cached response");Object(Ka.c)()?
(E.ULS.sendTraceTag(507847580,306,50,"Policy label boot call is still pending response."),Object(Ka.e)(this.wUf.bind(this))):(E.ULS.sendTraceTag(507847579,306,50,"Policy label boot call is being used to populate policy label info"),this.wUf())}wUf(){this.zUf(Object(Ka.b)(),Object(Ka.a)());this.tzg(1,!0)}tzg(Rb,dc){this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)&&this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableEdgeBlockScreenCapture",
!1)&&dc&&this.Kzk();db.Health.instance.recordKpiSuccess("MipGetPolicyLabel",this.izc(void 0,Rb,this.cSb));this.cSb=null;Rb=new sa(Rb);this.nck(Rb);dc&&this.dKk()?(this.hXf?this.f6k(this.R5f!==this.$eb):(this.ufe(Rb),this.Dcd=!0),this.Vx()&&(this.R5f=this.$eb),this.Vx()||(this.ufe(Rb),this.Dcd=!0)):dc||this.vfe()}Q9d(Rb){this.OSa&&(this.OSa.stop(),this.OSa=null);var dc=null;Rb&&Rb.data&&(dc=Rb.data.aF);let $a;this.Vje(!1);({data:$a}=this.Bye(Rb)).returnValue?(E.ULS.sendTraceTag(34996493,306,50,"Request to get label policy data succeeded."),
this.JCb=0,dc=this.o4j($a,dc),this.tzg(this.oKf(Rb.data),dc)):this.vfe()}dKk(){if(!this.Ha.ka("WacApplyManualPolicyLabelIsEnabled"))return E.ULS.sendTraceTag(539877667,306,50,"ShouldAutoClassificationRun returned false - Manual Labeling is not enabled"),!1;if(!this.kJh())return!1;if(""===this.iC)return E.ULS.sendTraceTag(539877696,306,50,"ShouldAutoClassificationRun returned true - document is not labeled"),!0;if(this.$eb===this.a8i)return E.ULS.sendTraceTag(539877697,306,50,"ShouldAutoClassificationRun returned false - Applied label already has the highest priority"),
!1;E.ULS.sendTraceTag(539877698,306,50,"ShouldAutoClassificationRun returned true - document is labeled but not with the highest priority label");return!0}zsc(){this.$4g();E.ULS.sendTraceTag(545104324,306,50,"Creating AutoCLP Security nodes. HasSITs: {0}, LabelPriority: {1}",0<this.cUa.count,this.$eb);const Rb=ab.toArray(this.cUa);this.cck(Rb,Rb,this.$eb)}f6k(Rb){var dc=this.cUa;this.$4g();ab.gDk(dc,this.cUa)||(E.ULS.sendTraceTag(545104325,306,50,"Updating AutoCLP SIT nodes. HasSITs: {0}",0<this.cUa.count),
dc=ab.toArray(this.cUa),this.kdk(dc,dc));dc=this.$eb;if(this.Vx()?Rb:this.ePe)E.ULS.sendTraceTag(545104326,306,50,"Updating AutoCLP Label Priority node. LabelPriority: {0}",dc),this.jdk(dc)}$4g(){var Rb;const dc=new Ua.a(M.a.zm());for(const $a of this.Nn.SensitivityLabels)if(0<(null===(Rb=null===$a||void 0===$a?void 0:$a.AutoLabelingSensitiveTypeIds)||void 0===Rb?void 0:Rb.length))for(const Wb of $a.AutoLabelingSensitiveTypeIds)Wb&&dc.add(Wb);this.cUa=dc}P9d(Rb){const dc=this.oKf(Rb.data);let $a=
null;Rb&&Rb.data&&($a=Rb.data.aF);db.Health.instance.recordKpiFailure("MipGetPolicyLabel","GetPolicyLabelsFailure",!1,!1,this.izc(void 0,dc,this.cSb));this.cSb=null;this.OSa&&(this.OSa.stop(),this.OSa=null);if(this.JCb<=this.Vgc){if(this.Ha.ka("SendHostAttributionInfoForPolicyLabelEnabled")){const Wb=Rb.data.request.get_headers();if("HostAttributionInfo.ScenarioParamName"in Wb&&Wb[La.a.HWc]&&"HostAttributionInfo.ScenarioTypeParamName"in Wb&&Wb[La.a.g6b]){Rb.data.request.get_headers();Rb.data.request.get_headers()[La.a.g6b];
Rb=this.Zyd(dc);this.iAc(this.iC,Rb,this.jDa,void 0,dc,$a);return}}this.iRb(this.iC,dc,this.jDa,!1,$a)}else E.ULS.sendTraceTag(34996494,306,15,"Request to get label policy failed with error response: {0}.",Rb?Rb.data?Rb.data.L6a:null:null),this.vfe(),this.JCb=0,this.Vje(!1)}oKf(Rb){return Rb.state?Rb.state:0}U2b(Rb,dc=!1){return Object(Xb.c)(this.Ha.Za("PolicyHandlerWebServiceBase")||r.AFrameworkApplication.ra.$g.w1,this.bVe,r.AFrameworkApplication.Jo,Rb===Xb.e&&r.AFrameworkApplication.FI&&r.AFrameworkApplication.FI.pZf,
Rb,dc)}ILf(Rb){let dc=null,$a=null,Wb=null;Rb&&Rb.data&&Rb.data.request&&Rb.data.request.get_headers()&&(dc=Rb.data.request.get_headers()[pb.a.KMg],$a=Rb.data.request.get_headers()[pb.a.xQg],Wb=Rb.data.aF);return{JMg:dc,wQg:$a,aF:Wb}}Bye(Rb){Rb=Rb?Rb.data?Rb.data.responseData:null:null;return Rb&&Rb.length&&!this.Pqj(Rb)?{returnValue:!0,data:Rb}:(E.ULS.sendTraceTag(25565152,306,10,"No response data from policy endpoint."),{returnValue:!1,data:Rb})}g4j(Rb){let dc;try{dc=xc.b(Rb)}catch($a){E.ULS.sendTraceTag(37880331,
306,10,"Error when deserializing DataLossPrevention response.");return}if(dc)if(dc.IsPolicyTipAvailable)switch(dc.IsPolicyTipAvailable.toLowerCase()){case "false":E.ULS.sendTraceTag(26007261,306,50,"policyData.IsPolicyTipAvailable is false so DLP policy tip is not present.");break;case "true":E.ULS.sendTraceTag(25565186,306,50,"DLP Policy is enabled on this document.");this.W9c=dc.NavigateUrl;this.cQk(dc.GeneralText,Object(N.a)(this,this.jQj,"onDataLossPolicyOverrideButtonClick"));break;default:E.ULS.sendTraceTag(26007262,
306,10,"policyData.IsPolicyTipAvailable is expected to be 'true' or 'false' but it is {0}",dc.IsPolicyTipAvailable)}else E.ULS.sendTraceTag(26007260,306,10,"policyData.IsPolicyTipAvailable is null or empty whereas it should be 'true' or 'false'.");else E.ULS.sendTraceTag(25565185,306,10,"policyData is null after deserializing DataLossPrevention response.")}X2h(Rb){switch(Rb){case "CoherencyFailure":return 1;case "DisabledByPolicy":return 2;case "FileCheckedOut":return 3;case "FileEncrypted":return 4;
case "FileLocked":return 5;case "FileNotSupported":return 6;case "FileTooLarge":return 7;case "InvalidOperationOnZeroByteFile":return 8;case "LabelDisabled":return 9;case "LabelErrorRetryLater":return 10;case "LabelIdNotFound":return 11;case "LabelIrmDisabledByTenant":return 12;case "LabelNotSupported":return 13;case "MinorVersionLimitExceeded":return 15;default:return 0}}B4j(Rb,dc,$a,Wb,rc,xb){var ic=Wb?Wb.tX:2;let Rc=0;var Zc="";let Kd;if(({wz:Kd}=xc.d(Rb)).returnValue)if(Kd){Zc="Success";Rb=this.Zyd(3);
if(Kd.IsSuccessful){db.Health.instance.recordKpiSuccess("MipSetPolicyLabel",this.izc(ic,void 0,this.v7b));this.EYb=this.v7b=null;E.ULS.sendTraceTag(51233632,306,50,"setPolicyLabel was successful as seen after deserializing set policy label data response. ApplyLabelFlag: {0}",ic);2===ic&&this.dqa(29);this.xGk(dc,ic);this.LKj();this.dqa(28);this.q6()?Wb&&4===ic&&(Zc=rc.startsWith("OFFICEJS_SENSITIVITY_CONTEXT_"),this.mHb(28,Zc?"SENSITIVITY":Object(S.a)("PolicyBusinessBarTitle"),String.format(Zc?"Due to content created by Copilot, your organization automatically applied the sensitivity label: {0}.":
Object(S.a)("PolicyLabelAutomaticallyAppliedMessage"),Wb.displayName),Object(S.a)("DialogOk"),()=>{})):Wb&&4===ic&&this.mHb(28,Object(S.a)("PolicyBusinessBarTitle"),String.format(Object(S.a)("PolicyLabelAutomaticallyAppliedMessage"),Wb.displayName),Object(S.a)("DialogOk"),()=>{});ea.a("MipAppliedLabels",void 0,void 0,[{name:"SetPolicyLabelApplyFlag",string:Ja[ic]}]);this.iAc(dc,Rb,this.jDa,void 0,3,rc);return}E.ULS.sendTraceTag(51233631,306,10,"setPolicyLabel was unsuccessful as seen after deserializing set policy label data response. ApplyLabelFlag: {0}, FailureReason: {1}",
ic,Kd.FailureReason);this.EYb=Kd.FailureReason;Rc=this.X2h(Kd.FailureReason);this.Tqj&&0<=Kd.FailureReason.indexOf("InvalidOperationOnZeroByteFile")&&(Wb=new Ab.a(2,1,this.AFk,()=>{E.ULS.sendTraceTag(575428443,306,15,"Retring SetPolicyLabelRequestAsync as previous called failed due to zero byte. Attempt number : {0}",this.jFa);this.jFa<=this.Vgc&&(this.Vx()?this.Jpe(dc,$a,this.$yd(null),null,rc,xb):this.rYc(dc,$a,null,rc))}),this.Fk.wm(Wb));this.ZFc&&this.supportsOfficeClientCoauthoring&&this.iAc(this.Nn.AppliedPolicyId,
Rb,this.jDa,!0,3,rc)}else Zc="setPolicyLabelData null.",E.ULS.sendTraceTag(42467541,306,10,"setPolicyLabelData is null after deserializing set policy label data response. ApplyLabelFlag: {0}",ic);else Zc="TryDeserialize failed.",E.ULS.sendTraceTag(41799709,306,10,"Error when deserializing set policy label data response. ApplyLabelFlag: {0}",ic);this.Ule(ic,rc,Rc,xb);ic=this.izc(ic,void 0,this.v7b);this.v7b=null;ic.extendedProperties.set("SetPolicyLabelDataFailureReason",this.EYb);ic.extendedProperties.set("SetPolicyLabelDataParseStatus",
Zc.toString());db.Health.instance.recordKpiFailure("MipSetPolicyLabel","SetPolicyLabelFailure",!1,!1,ic)}rlb(Rb){if(""===Rb)return null;for(const dc of this.Nn.SensitivityLabels)if((null===dc||void 0===dc?void 0:dc.Id)===Rb)return dc;return null}W4g(){if(""!==this.iC)if(this.Vx()){var Rb=this.VW[this.iC];Rb&&(Rb.HasExtractForUser=this.soa(Rb)?this.Nn.ExtractEnabled:!0)}else for(Rb of this.Nn.SensitivityLabels)(null===Rb||void 0===Rb?void 0:Rb.Id)===this.iC&&(Rb.HasExtractForUser=this.soa(Rb)?this.Nn.ExtractEnabled:
!0)}Ule(Rb,dc,$a,Wb){E.ULS.sendTraceTag(507576852,306,50,"revertAppliedPolicyId called. ErrorType: {0}",$a);const rc=2===Rb||8===Rb||16===Rb,xb=new Oa;this.Vx()?this.Y6b(Wb):this.Kwb(this.IRa);this.q6()&&(this.Vx()||(xb.ync=this.rlb(this.iC)),xb.context=dc,xb.vQg=$a);this.wzg(xb);this.Ffe($a,Rb,rc,!1)}xGk(Rb,dc){this.Vx()?this.Y6b(Rb):this.Kwb(this.IRa=Rb);if(!this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1))if(""===Rb)r.AFrameworkApplication.protectedFile=
!1,r.AFrameworkApplication.enableMacrosForProtectedFile=!1;else for(const $a of this.Nn.SensitivityLabels)if($a.Id===Rb){r.AFrameworkApplication.protectedFile=this.soa($a);break}this.cdk(new Ac(Rb,dc))}o6g(){if(!this.Vx())for(const Rb of this.Nn.SensitivityLabels)if(null===Rb||void 0===Rb?0:Rb.Enabled)Rb.Id===this.IRa&&(this.ePe=this.z7c!==Rb.Order,this.z7c=Rb.Order),Rb.Order>this.Jbd&&(this.Jbd=Rb.Order)}J6g(){var Rb=this.iC;this.Ha.appSettings&&(this.Vx()?this.Ha.appSettings.AppliedPolicyId=Rb:
this.Ha.appSettings.AppliedPolicyId=this.iC);var dc=!1;if(this.Vx())Rb&&(Rb=this.VW[Rb])&&(dc=this.soa(Rb));else if(""!==this.iC)for(var $a of this.Nn.SensitivityLabels)if($a.Id===this.iC){dc=this.soa($a);break}if(this.Vx())if(r.AFrameworkApplication.protectedFile=dc){dc=this.Nn.EditEnabled;Rb=this.Nn.PrintEnabled;$a=this.Nn.MacrosEnabled;const Wb=this.Nn.ExtractEnabled,rc=this.Nn.ExportEnabled,xb=this.Nn.FullControlEnabled;r.AFrameworkApplication.qAa=this.Nn.ViewEnabled&&!dc;r.AFrameworkApplication.printingEnabled=
Rb;r.AFrameworkApplication.enableMacrosForProtectedFile=$a;r.AFrameworkApplication.enableExtractForProtectedFile=Wb;r.AFrameworkApplication.bjb=rc;r.AFrameworkApplication.cjb=xb}else r.AFrameworkApplication.qAa=!1,r.AFrameworkApplication.printingEnabled=!1,r.AFrameworkApplication.enableMacrosForProtectedFile=!1,r.AFrameworkApplication.enableExtractForProtectedFile=!1,r.AFrameworkApplication.bjb=!1,r.AFrameworkApplication.cjb=!1;else r.AFrameworkApplication.protectedFile=dc,r.AFrameworkApplication.qAa=
dc?this.Nn.ViewEnabled&&!this.Nn.EditEnabled:!1,r.AFrameworkApplication.printingEnabled=dc?this.Nn.PrintEnabled:!1,r.AFrameworkApplication.enableMacrosForProtectedFile=dc?this.Nn.MacrosEnabled:!1,r.AFrameworkApplication.enableExtractForProtectedFile=dc?this.Nn.ExtractEnabled:!1,r.AFrameworkApplication.bjb=dc?this.Nn.ExportEnabled:!1,r.AFrameworkApplication.cjb=dc?this.Nn.FullControlEnabled:!1}zUf(Rb,dc){if(!Rb)return E.ULS.sendTraceTag(42467542,306,10,"policyData is null after deserializing label policy data response."),
!1;if(!Rb.AreLabelsAvailable)return!1;this.Nn=Rb;this.Vx()?this.Y6b(Rb.AppliedPolicyId):this.IRa=Rb.AppliedPolicyId;this.q6()&&(this.Vx()||this.W4g());this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)?this.Vx()||this.J6g():this.Ha.appSettings&&(this.Ha.appSettings.AppliedPolicyId=this.iC);this.o6g();this.Bea()&&E.ULS.sendTraceTag(51197846,306,50,"Labels are available for display after GetPolicyLabels call.");Rb=new Oa(!0);this.q6()&&(this.Vx()||(Rb.ync=
this.rlb(this.iC)),Rb.context=dc);this.wzg(Rb);return!0}o4j(Rb,dc=null){return({wz:Rb}=xc.d(Rb)).returnValue?this.zUf(Rb,dc):(E.ULS.sendTraceTag(34996495,306,10,"Error when deserializing label policy data response."),!1)}kJh(){var Rb;if(!this.Bea())return E.ULS.sendTraceTag(539877699,306,50,"AreAutoLabelingSensitiveTypesAvailable returned false - No labels to display"),!1;for(const dc of this.Nn.SensitivityLabels)if(0<(null===(Rb=null===dc||void 0===dc?void 0:dc.AutoLabelingSensitiveTypeIds)||void 0===
Rb?void 0:Rb.length))return!0;E.ULS.sendTraceTag(539877700,306,50,"AreAutoLabelingSensitiveTypesAvailable returned false - No labels with AutoClp SIT");return!1}wzg(Rb){E.ULS.sendTraceTag(35393610,306,50,"Raising label info update event.");this.Vx()&&(this.fEk(),this.rFk(),this.J6g(),this.q6()&&this.W4g(),Rb.ync=this.VW[this.iC]);this.hh.raiseEvent("LabelInfoUpdateEvent",Rb)}nck(Rb){E.ULS.sendTraceTag(50676305,306,50,"Raising get policy label event.");this.hh.raiseEvent("GetPolicyLabelEventKey",Rb)}vfe(){Da.iVc(!1);
this.hh.raiseEvent("GetPolicyLabelFailureEventKey",new oa)}ufe(Rb){this.b_&&this.b_.execute(dc=>{dc=[dc.isFeatureEnabled("MsoClpSpTwo",!0),dc.isFeatureEnabled("MsoDrmPremiumSpTwo",!0)];Promise.all(dc).then($a=>{tb.a.any($a,Wb=>Wb)&&(E.ULS.sendTraceTag(50944077,306,50,"Raising get auto policy label event."),this.hh.raiseEvent("GetAutoPolicyLabelEventKey",Rb),this.zsc(),ea.a("MipAutoClassificationEnabled"));return null})})}fLd(Rb=null,dc=null){const $a=new Map;$a.set("ClpCoauth",this.supportsOfficeClientCoauthoring.toString());
null!=Rb&&$a.set("ApplyLabelFlags",Ja[Rb]);null!=dc&&$a.set("GetPolicyLabelsReason",xa[dc]);return $a}izc(Rb=null,dc=null,$a=null){const Wb={};Wb.extendedProperties=this.fLd(Rb,dc);null!=$a&&(Wb.durationMs=this.SF()-$a);return Wb}cdk(Rb){E.ULS.sendTraceTag(41799710,306,50,"Raising set policy label event.");this.hh.raiseEvent("SetPolicyLabelEventKey",Rb)}dzg(Rb){E.ULS.sendTraceTag(51128227,306,50,"Raising an add auto policy business bar entry event.");Rb&&Rb.XWb&&ea.a("MipRecommendations");this.hh.raiseEvent("AddAutoPolicyBusinessBarEntryEventKey",
Rb)}Ozg(Rb){E.ULS.sendTraceTag(51128256,306,50,"Raising an remove auto policy business bar entry event.");this.hh.raiseEvent("RemoveAutoPolicyBusinessBarEntryEventKey",Rb)}Tbk(Rb){E.ULS.sendTraceTag(573842331,306,50,"Raising an add mandatory labelling business bar entry event.");this.hh.raiseEvent("AddMandatoryLabellingBusinessBarEntryEventKey",Rb)}Xck(Rb){E.ULS.sendTraceTag(573842332,306,50,"Raising a remove mandatory labelling business bar entry event.");this.hh.raiseEvent("RemoveMandatoryLabellingBusinessBarEntryEventKey",
Rb)}cQk(Rb,dc=null){E.ULS.sendTraceTag(34996496,306,50,"Showing policy tip to user.");this.hh.raiseEvent("PolicyTipEvent",new bc(Object(S.a)("PolicyBusinessBarTitle"),Rb,Object(S.a)("PolicyOverrideButton"),dc))}Ffe(Rb,dc,$a,Wb=!0){E.ULS.sendTraceTag(42074656,306,Wb?50:15,"Raising set policy label failure event. ApplyLabelFlags: {0}",dc);Wb=Object(S.a)("SensitivityApplicationErrorBusinessBarTitle");let rc=Object(S.a)("SensitivityApplicationErrorBusinessBarMessage"),xb=null,ic=null;switch(Rb){case 2:Wb=
Object(S.a)("SensitivityApplicationErrorDisabledByPolicyBusinessBarTitle");rc=Object(S.a)("SensitivityApplicationErrorDisabledByPolicyBusinessBarMessage");break;case 5:rc=Object(S.a)("SensitivityApplicationErrorFileLockedBusinessBarMessage");break;case 7:Wb=Object(S.a)("SensitivityApplicationErrorFileTooLargeBusinessBarTitle");rc=Object(S.a)("SensitivityApplicationErrorFileTooLargeBusinessBarMessage");break;case 13:Wb=Object(S.a)("SensitivityApplicationErrorLabelNotSupportedBusinessBarTitle");rc=
Object(S.a)("SensitivityApplicationErrorLabelNotSupportedBusinessBarMessage");break;case 9:Wb=Object(S.a)("SensitivityApplicationErrorLabelDisabledBusinessBarTitle");rc=Object(S.a)("SensitivityApplicationErrorLabelDisabledBusinessBarMessage");break;case 10:rc=Object(S.a)("SensitivityApplicationErrorLabelErrorRetryLaterBusinessBarMessage");break;case 14:Wb=Object(S.a)("SensitivityCoauthMandatoryApplicationErrorTitle");rc=Object(S.a)("SensitivityCoauthMandatoryApplicationErrorMessage");break;case 15:Wb=
Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedBusinessBarTitle"),rc=Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedBusinessBarMessage"),xb=Object(S.a)("LearnMore"),ic=()=>{this.BFk()}}Rb=new mc(Rb,dc,$a,Wb,rc,xb,ic);this.hh.raiseEvent("SetPolicyLabelFailureEventKey",Rb)}LEk(Rb){this.dfd=Rb}jQj(){this.W9c?(E.ULS.sendTraceTag(25565187,306,50,"DLP override button was clicked."),vc.a.z0(this.W9c)):E.ULS.sendTraceTag(25565188,306,10,"Null NavigateUrl got in policy response. Could not navigate to SPO.")}Pqj(Rb){if(!Rb.startsWith("<")||
-1===Rb.indexOf("Error")&&-1===Rb.indexOf("Unavailable"))return!1;E.ULS.sendTraceTag(25565189,306,10,"The response from server is not a valid JSON response and it matches the error page keyword. This might be the error response from a non-existing endpoint.");return!0}jvg(){this.Xhc&&(this.Xhc.stop(),this.Xhc=null)}EDi(Rb){if(!Rb)return"manual";switch(Rb.tX){case 0:return"manual";case 4:return"auto";case 1:return"default";case 16:return"mandatory";case 2:return"manual";case 8:return"recommended";
case 32:return"ai";default:return"manual"}}PEi(Rb){if(!Rb)return"privileged";Rb=Rb.tX;let dc="privileged";if(4===Rb||1===Rb||32===Rb)dc="standard";return dc}iAc(Rb,dc,$a=null,Wb=!1,rc=0,xb=null){this.Ha.ka("WacLabelingGetPolicyLabelsIsEnabled")&&(this.Vx()?this.Y6b(Rb):this.IRa=Rb,this.jDa=$a,this.Io&&(this.OSa=this.Io.Li("WebServiceCall","Call Get Policy Endpoint On Server")),Object(Xb.d)(this.Ha,this.Yn,Object(N.a)(this,this.Q9d,"onGetPolicyLabelsSuccessCallback"),Object(N.a)(this,this.P9d,"onGetPolicyLabelsFailureCallback"),
this.U2b("getpolicylabels",Wb),Rb,dc,rc,xb),this.JCb++,E.ULS.sendTraceTag(34996492,306,50,"Policy label request sent to server. Policy call times: {0}",this.JCb))}Jpe(Rb,dc,$a,Wb,rc,xb){if(this.JFc){this.Io&&(this.eUa=this.Io.Li("WebServiceCall","Call Set Policy Endpoint On Server"));var ic={};ic[pb.a.KMg]=Rb;dc&&(ic[pb.a.xQg]=encodeURIComponent(dc));this.dfd&&(ic[pb.a.GHh]=this.dfd);Wb?(ic[pb.a.tQg]=this.EDi(Wb),ic[pb.a.uQg]=this.PEi(Wb),1===Wb.tX&&this.Nn.DefaultLabelType&&(ic[pb.a.yFk]=this.Nn.DefaultLabelType)):
(ic[pb.a.tQg]="manual",ic[pb.a.uQg]="privileged");this.supportsOfficeClientCoauthoring&&this.Nn&&(ic[pb.a.E6j]=this.Nn.PolicyLabelVersionToken);this.Ha.ka("SendHostAttributionInfoForPolicyLabelEnabled")?(Rb=new zb.a(this.U2b(Xb.e,!0),1,null,ic,!0,2,Wb,void 0,this.q6()?rc:void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,$a),this.Yn.send(Rb).ghe(Rc=>this.yqg(Rc,xb),Rc=>this.xqg(Rc,xb))):this.Yn.lv(this.U2b(Xb.e,!0),1,null,ic,!0,2,Rc=>this.yqg(Rc,xb),Rc=>this.xqg(Rc,xb),Wb,
this.q6()?rc:void 0,void 0,void 0,void 0,"32");this.jFa++;E.ULS.sendTraceTag(41799706,306,50,"Set policy label request sent to server. Policy call times: {0}",this.jFa)}else E.ULS.sendTraceTag(570972052,306,50,"SetPolicyLabelRequestInternalAsync was exited - ApplyManualPolicyLabel was not enabled.")}BFk(){const Rb=new va.a,dc=this.Ha.Za("BreadcrumbFolderUrl");dc?(Rb.Ph=11,Rb.ri(1,Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoAction")),Rb.ri(2,Object(S.a)("DialogOk"))):(Rb.Ph=
0,Rb.ri(1,Object(S.a)("DialogOk")));Rb.B2e(Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoHelpText"),"0f6cd105-974f-44a4-aadb-43ac5bdfd247");Rb.Zjk();Rb.iW(Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoTitle"),Object(S.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoMessage"),$a=>{1===$a&&dc&&vc.a.Cm(dc,"_blank",void 0,"SetPolicyLabelFailureBusinessBarActionCallback.BreadcrumbFolderUrl")})}Zyd(Rb){return Object(Xb.b)(Rb)}$yd(Rb=null){if(!Rb)return La.a.kva(8,
0);switch(Rb.tX){case 1:case 16:return La.a.kva(1,1);case 4:case 2:case 8:return La.a.kva(8,1);default:return La.a.kva(8,0)}}Vje(Rb){ya.c()&&appChrome.api.setAsyncRequestStatus("sensitivity",Rb)}kna(Rb){return Rb?Rb.ParentId&&Rb.ParentName?Rb.ParentName+"\\"+Rb.DisplayName:Rb.DisplayName:""}getHighestSensitivityLabel(Rb){if(!Rb||0==Rb.length)return null;let dc=null;for(const $a of Rb)if(""!==$a)if(this.Vx())if(Rb=this.VW[$a]){if(!dc||Rb.Order>dc.Order)dc=Rb}else return null;else{Rb=!1;for(const Wb of this.Nn.SensitivityLabels)(null===
Wb||void 0===Wb?void 0:Wb.Id)===$a&&(Rb=!0,!dc||Wb.Order>dc.Order)&&(dc=Wb);if(!Rb)return null}dc||(dc=new ka.a);return dc}FEi(){if(""===this.iC)return[!0,new ka.a];if(this.Ha.ka("SupportsPolicies")){let Rb;Rb=this.Vx()?this.VW[this.iC]:this.rlb(this.iC);return Rb?[!0,Rb]:(E.ULS.sendTraceTag(507557842,306,10,"GetAppliedLabel couldn't find an applied label from policy"),[!1,2147205112])}return[!1,2147205115]}tryUpgradeLabel(Rb,dc){if(""===Rb.Id)return 0;var $a=this.Vx()?this.VW[this.iC]:this.rlb(this.iC);
Rb=this.Vx()?this.VW[Rb.Id]:this.rlb(Rb.Id);if(!Rb)return 2147205112;if(!Rb.Enabled)return 2147205117;if(Rb.HasUserDefinedPermissions)return 2147205116;if(1==r.AFrameworkApplication.yh.mode)return 2147205119;if(Rb.RequiredDowngradeJustification||(null===$a||void 0===$a?void 0:$a.Order)>=Rb.Order)return 2147205105;$a=new R(4,this.kna(Rb));this.rYc(Rb.Id,"",$a,dc);return 0}Vx(){return za(this.Ha)}}Object(h.a)(ia,"PolicyManager",null,[572]);var kb=a(145),fb=a(282);class hb{constructor(){this.nda=this.WEa=
this.Vh=this.$l=null;this.Rgg=()=>{this.nda=Object(l.a)();this.$l||(this.$l=A());this.WEa=w.a.instance.resolve("Common.App.Policy.PolicyActor");ya.a("isSharedUxGateEnabled")&&appChrome.api.isSharedUxGateEnabled("SharedOnline.ChangeGate.DelayPolicyActionRegistration")?this.$l.RHb(Object(N.a)(this.WEa,this.WEa.uCg,"registerActionsHandler")):this.WEa.ho();this.$l.RHb(this.Wze);r.AFrameworkApplication.fa.ka("WacApplyManualPolicyLabelIsEnabled")&&(this.$l.vpd(this.M4i),this.$l.G3e(this.mHb),this.$l.O4e(this.dqa),
this.$l.H3e(this.Snd),this.$l.P4e(this.iie))};this.Wze=()=>{za()||(this.WEa.CPg(),this.WEa.qQg());this.WEa.Qyg();const Rb=this.$l.oWh();r.AFrameworkApplication.fa.ka("HasDocumentEditRights")&&!Rb?this.WEa.X1g():E.ULS.sendTraceTag(558682911,306,50,"Default/Mandatory Labeling has been skipped because HasDocumentEditRights: {0}, IsClpBlockedByAppSpecificScenario: {1}",r.AFrameworkApplication.fa.ka("HasDocumentEditRights"),Rb);r.AFrameworkApplication.ra.UB()};this.ste=(Rb,dc)=>{Rb=this.mKf(dc.title,dc.HRc,
38,dc.Ihg,dc.buttonText);r.AFrameworkApplication.ra.$g.ulc(Rb)?E.ULS.sendTraceTag(34174785,306,50,"Add entry to BusinessBar succeeded. Policy message is shown to user."):E.ULS.sendTraceTag(34174784,306,10,"Failed to add entry to business bar. Policy message could not be shown to user.")};this.M4i=(Rb,dc)=>{dc.fVg&&(Rb=this.mKf(dc.title,dc.message,21,null,null,dc.Ela,dc.buttonText),r.AFrameworkApplication.ra.$g.ulc(Rb)?E.ULS.sendTraceTag(42074655,306,50,"Add entry to BusinessBar succeeded. CLP policy message is shown to user."):
E.ULS.sendTraceTag(42074654,306,10,"Failed to add entry to business bar. CLP policy message could not be shown to user."))};this.dqa=()=>{};this.mHb=(Rb,dc)=>{this.nda&&(this.$l.dqa(dc.PJb),Rb=new D.a(dc.title,dc.message,null),Rb.id=dc.PJb,Rb.closeable=!0,Rb.image=3,Rb.addButton(dc.buttonText,dc.Ela,dc.buttonText,!0),this.nda.EF(Rb,!1))};this.Snd=(Rb,dc)=>{this.nda&&(Rb=new D.a(dc.title,dc.message,null),Rb.id=dc.PJb,Rb.closeable=!1,Rb.image=3,Rb.addButton(dc.buttonText,dc.Ela,dc.buttonText,!1),this.nda.EF(Rb,
!1))};this.iie=()=>{}}get name(){return"Common.App.Policy"}init(){r.AFrameworkApplication.fa.ka("ShouldInitCommonPolicyPackage")&&(r.AFrameworkApplication.fa.ka("IsDataLossPreventionEnabledForUser")&&r.AFrameworkApplication.ra&&(this.$l=A(),this.$l.N4e(this.ste),E.ULS.sendTraceTag(36537375,306,50,"PolicyManager is created successfully."),r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.InitPolicyManagerEarlierEnabled",!1)?kb.a.get_instance().Qm(5,()=>{this.$l.jAc()}):
kb.a.get_instance().Qm(6,()=>{this.$l.jAc()})),r.AFrameworkApplication.fa.ka("WacLabelingPoliciesIsEnabled")&&r.AFrameworkApplication.fa.ka("SupportsPolicies")?r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.InitPolicyManagerEarlierEnabled",!1)?kb.a.get_instance().Qm(5,this.Rgg):kb.a.get_instance().Qm(6,this.Rgg):(Da.Q9k(),Da.iVc(!1)))}dispose(){}$n(Rb){Rb.register(572,"Common.App.Policy.Contracts.IPolicyManager").yi().Ei(()=>new ia(r.AFrameworkApplication.fa,r.AFrameworkApplication.sj,
r.AFrameworkApplication.ra.wL,r.AFrameworkApplication.fa.Lj("MaxGetPolicyRetries",1),Object(B.a)(),r.AFrameworkApplication.ra.$g.kn));Rb.register(Da,"Common.App.Policy.PolicyActor").as("Common.App.Policy.Contracts.IPolicyActor").yi().Ei(()=>new Da(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,Object(y.b)()));this.Vh=Rb}mKf(Rb,dc,$a,Wb=null,rc=null,xb=null,ic=null){Rb=new D.a(Rb,dc,null);Rb.id=$a;Rb.closeable=!0;Wb&&Rb.Cyh(rc,Wb);xb&&Rb.addButton(ic,xb,ic);return Rb}static main(){fb.a.instance.Do(new hb)}}
Object(h.a)(hb,"PackageManager",null,[12,13]);var Jb=a(9),ub=a(598),nb=a(428),Aa=a(39),ra=a(153),vb=a(40),rb=a(427),Nb=a(216),Qc=a(83),jd=a(36),xd=a(254),ae=a(1),Sd=a(28),fc=a(264);class uc{constructor(){this.GRc=this.CNg=null;this.tX=0}}Object(h.a)(uc,"ApplyPolicyContextParameters",null,[]);var hc=a(2),Ec=a(908),yd=a(663),Ad=a(58),$b=a(54);class Ob{constructor(){this.Ueb=this.annotationType=null;this.lnb=this.QK=!1}}Object(h.a)(Ob,"AnnotationActivationOptions",null,[]);var Yc=a(1154),zd=a(937),Dd=
a(913);class oc extends zd.a{constructor(){super();this.source=this.automatic=this.recommended=null;this.H_=Object.assign(new Dd.a,{T_:oc.getTypeName(),B_:oc.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityClp_LabellingAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}Object(h.a)(oc,"LabellingAnnotation",zd.a,[]);var $c=a(924);class yb extends $c.a{constructor(){super();this.fullDocSITs=this.partialDocSITs=null;this.H_=Object.assign(new Dd.a,{T_:yb.getTypeName(),B_:yb.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityShared_SecurityShared"}static getBaseTypes(){return[]}}
Object(h.a)(yb,"SecurityShared",$c.a,[]);class qb extends yb{constructor(){super();this.existingLabelPriority=null;this.H_=Object.assign(new Dd.a,{T_:qb.getTypeName(),B_:qb.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityShared_CLP"}static getBaseTypes(){return["AugLoop_SecurityShared_SecurityShared"]}}Object(h.a)(qb,"CLP",yb,[]);var Cb=a(1357),gc=a(1128),Mc=a(1359);class bd extends zd.a{constructor(){super();this.classificationId=null;this.H_=Object.assign(new Dd.a,{T_:bd.getTypeName(),
B_:bd.getBaseTypes()})}static getTypeName(){return"AugLoop_LinkedDataType_LinkedDataTypeAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}Object(h.a)(bd,"LinkedDataTypeAnnotation",zd.a,[]);var Id=a(91);class Vd extends vb.a{constructor(Rb,dc,$a,Wb,rc){super();this.Lbg=3;this.E_=this.Zo=null;this.Prd=!1;this.Fsb=[];this.c6f=new Ec.a(yd.a.RU());this.dee=0;this.iee=null;this.zsc=(xb,ic)=>{xb=Object(hc.a)(new Cb.a,{parentPath:["session","doc","security"],items:[Object(hc.a)(new gc.a,
{id:"clp",body:Object(hc.a)(new qb,{existingLabelPriority:ic.existingLabelPriority,partialDocSITs:ic.ygf,fullDocSITs:ic.xgf})})]});this.Fsb.push(xb);this.nUb()};this.Y4g=(xb,ic)=>{xb=Object(hc.a)(new Mc.a,{parentPath:["session","doc","security"],items:[Object(hc.a)(new gc.a,{id:"clp",body:Object(hc.a)(new qb,{existingLabelPriority:ic.existingLabelPriority})})]});this.Fsb.push(xb);this.nUb()};this.Z4g=(xb,ic)=>{xb=Object(hc.a)(new Mc.a,{parentPath:["session","doc","security"],items:[Object(hc.a)(new gc.a,
{id:"clp",body:Object(hc.a)(new qb,{partialDocSITs:ic.ygf,fullDocSITs:ic.xgf})})]});this.Fsb.push(xb);this.nUb()};this.EA=()=>{E.ULS.sendTraceTag(537154588,306,50,`AutoPolicyManager::OnApplicationModeChanged - isEditMode:${this.$.isEditMode}.`);this.$.isEditMode?this.nUb():(this.businessBar.removeEntry(41),this.businessBar.removeEntry(40),this.Bbi())};this.sNj=()=>{var xb;E.ULS.sendTraceTag(537154587,306,50,"AutoPolicyManager::OnAugmentationLoopSessionClose called.");null===(xb=this.Zo)||void 0===
xb?void 0:xb.unregister("AutoPolicy");this.Zo=null};this.Ruj=(xb,ic)=>{var Rc,Zc;E.ULS.sendTraceTag(537154586,306,50,"AutoPolicyManager::LabellingAnnotationHandler called.");if(3===ic.operationType)E.ULS.sendTraceTag(537154585,306,50,"AutoPolicyManager::LabellingAnnotationHandler Ignoring delete operation.");else{var Kd=xb=null,fe=null;if(ic=ic.annotation){if(null===(Rc=ic.automatic)||void 0===Rc?0:Rc.id)xb=ic.automatic.id;if(null===(Zc=ic.recommended)||void 0===Zc?0:Zc.id)Kd=ic.recommended.id,ic.recommended.policyTip&&
(fe=ic.recommended.policyTip);this.applyPolicyLabel(xb,Kd,fe,1)}else E.ULS.sendTraceTag(537154584,306,50,"AutoPolicyManager::LabellingAnnotationHandler LabellingAnnotation is null.")}};this.Wwj=(xb,ic)=>{E.ULS.sendTraceTag(537154582,306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Handler called.");3===ic.operationType?E.ULS.sendTraceTag(537154581,306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Received delete operation."):(xb=ic.annotation)?(xb=xb.classificationId,
this.applyPolicyLabel(xb,xb,null,2)):E.ULS.sendTraceTag(537154580,306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Received an empty annotation.")};this.zDg=(xb,ic)=>{ic?ic.XWb&&this.businessBar.iM(41)?(this.businessBar.removeEntry(41),E.ULS.sendTraceTag(537154562,306,50,"Remove entry to RecommendedSensitivityLabelBusinessBarEntry succeeded.")):!ic.XWb&&this.businessBar.iM(40)&&(this.businessBar.removeEntry(40),E.ULS.sendTraceTag(537154561,306,50,"Remove entry to AutomaticSensitivityLabelBusinessBarEntry succeeded.")):
E.ULS.sendTraceTag(537154563,306,15,"RemoveAutoPolicyBusinessBar is called but AddAutoPolicyBusinessBarEntryEventArgs is null.")};this.gUg=(xb,ic)=>{ic?ic.XWb?(this.businessBar.tQk(ic.title,ic.message,ic.buttonText,Rc=>{ic.Ela(Rc);this.businessBar.iM(41)&&this.businessBar.removeEntry(41)}),E.ULS.sendTraceTag(537154531,306,50,"Add entry to RecommendedSensitivityLabelBusinessBarEntry succeeded. Message is shown to user.")):(this.businessBar.QNk(ic.title,ic.message,ic.buttonText,Rc=>{ic.Ela(Rc);this.businessBar.iM(40)&&
this.businessBar.removeEntry(40)}),E.ULS.sendTraceTag(537154530,306,50,"Add entry to AutomaticSensitivityLabelBusinessBarEntry succeeded. Message is shown to user.")):E.ULS.sendTraceTag(537154560,306,15,"ShowAutoPolicyBusinessBar is called but AddAutoPolicyBusinessBarEntryEventArgs is null.")};this.Lce=Rb;this.policyManager=dc;this.$=$a;this.fa=Wb;this.businessBar=rc;this.z$i();this.Xgk();this.disposed=!1}get ki(){return!this.disposed&&this.$.ea.ki}dispose(){var Rb;this.disposed||(this.disposed=!0,
this.Cdi(),null===(Rb=this.Zo)||void 0===Rb?void 0:Rb.unregister("AutoPolicy"),this.Lce=this.policyManager=this.Zo=null,super.dispose())}afb(Rb,dc,$a,Wb,rc=!1){E.ULS.sendTraceTag(537154642,306,50,`AutoPolicyManager: ApplyAutoPolicyLabel called for LabellingSource ${Wb} with AutoLabelPresent: ${!!Rb}, RecommendedLabelPresent: ${!!dc}, isStandard: ${rc}.`);this.ki?this.Lce&&(this.LTh(dc,Wb)?(this.iee=dc,this.dee=Wb,this.c6f.ga(Wb,dc)):dc=this.iee,Rb=this.Lce.afb(Rb,dc,$a,rc),E.ULS.sendTraceTag(537154640,
306,50,`AutoPolicyManager::ApplyAutoPolicyLabel - policyActor.ApplyAutoPolicyLabel returned ${Rb}.`)):E.ULS.sendTraceTag(537154641,306,15,`AutoPolicyManager: ApplyAutoPolicyLabel failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}LTh(Rb,dc){if(!this.policyManager.Bea())return E.ULS.sendTraceTag(537154639,306,15,"CanShowRecommendedSensitivityLabel - Labels are not available."),!1;const $a=this.policyManager.Nn;let Wb;({value:Wb}=this.c6f.wj(this.dee));let rc=null,xb=
null,ic=null;for(const Rc of $a.SensitivityLabels)Rc.Id===Rb&&(rc=Rc),Rc.Id===Wb&&(xb=Rc),Rc.Id===this.iee&&(ic=Rc);return xb&&xb.Id===Rb?(E.ULS.sendTraceTag(537154638,306,50,"AutoPolicyManager: CanShowRecommendedSensitivityLabel - Suppressing the recommendation since it is same as last recommendation from current source."),!1):this.businessBar.iM(41)&&this.dee!==dc&&ic&&(!rc||ic.Order>=rc.Order)?(E.ULS.sendTraceTag(537154637,306,50,"AutoPolicyManager: CanShowRecommendedSensitivityLabel - Suppressing the recommendation since current label priority is lower than last label priority."),
!1):!0}gXf(){return ae.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPSecurityNodeCreation",!1)}Xgk(){this.policyManager.G3e(this.gUg);this.policyManager.O4e(this.zDg);this.$.ea.cK(this.EA);this.gXf()&&(this.policyManager.RBh(this.zsc),this.policyManager.SEh(this.Y4g),this.policyManager.TEh(this.Z4g))}Cdi(){this.businessBar.removeEntry(41);this.businessBar.removeEntry(40);this.policyManager.blk(this.gUg);this.policyManager.Nnk(this.zDg);this.$.ea.XH(this.EA);this.gXf()&&(this.policyManager.Plk(this.zsc),
this.policyManager.sok(this.Y4g),this.policyManager.tok(this.Z4g))}z$i(){this.E_=new Ec.a(yd.a.RU());const Rb=oc.getTypeName();this.E_.add(1,Object(hc.a)(new Ob,{annotationType:Rb,Ueb:this.Ruj,QK:!1,lnb:!1}));this.E_.add(2,Object(hc.a)(new Ob,{annotationType:bd.getTypeName(),Ueb:this.Wwj,QK:!1,lnb:!1}))}dZg(){for(const Rb of this.Fsb)this.Zo.submitOperation(Rb);this.Fsb=[]}$pa(Rb){if(!this.E_.kh(Rb))return E.ULS.sendTraceTag(537154636,306,15,`AutoPolicyManager::RegisterAnnotation - AnnotationActivationOptions not available for LabellingSource ${Rb}.`),
!1;if(this.E_.na(Rb).QK)return E.ULS.sendTraceTag(537154635,306,15,`AutoPolicyManager::RegisterAnnotation - Annotations already registered for LabellingSource ${Rb}.`),!0;this.E_.na(Rb).QK=!0;E.ULS.sendTraceTag(537154634,306,50,`AutoPolicyManager::RegisterAnnotation - Annotations registered for LabellingSource ${Rb}.`);if(!this.$.isEditMode)return E.ULS.sendTraceTag(537154633,306,50,"AutoPolicyManager::RegisterAnnotation - Skipping AugmentationLoop initialization in view mode."),!0;this.nUb();return!0}nUb(){var Rb=
0<this.Fsb.length;if(!Rb)for(const dc of this.E_)if(Rb=dc.value.QK||Rb)break;Rb?this.Zo?(E.ULS.sendTraceTag(537154627,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - AugmentationLoop already initialized."),this.Y0e(),this.dZg()):this.Prd?E.ULS.sendTraceTag(537154626,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - AugmentationLoop initialization in-progress."):(this.Prd=!0,Rb=this.$.ua.FlightingSettings.AutoCLPStartUpDelay,E.ULS.sendTraceTag(537154625,306,50,`AutoPolicyManager::InitAugmentationLoopIfNecessary - Initializing AugmentationLoop in ${Rb} milliseconds.`),
Ad.a.instance.create(()=>{this.C$i()},Rb,$b.a.vLh,!0,!0)):E.ULS.sendTraceTag(537154628,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - no registered annotations and operations.")}C$i(){Aa.TaskExtensions.Xa(Object(Id.d)(u.a.resolve(n.p,{va:1})),Rb=>{this.Zo=Rb.result;this.Prd=!1;this.Zo?(E.ULS.sendTraceTag(537154595,306,50,"AutoPolicyManager::InitAugmentationLoop - AugmentationLoopManager instantiated."),this.Zo.register(this.Zo.v5().b8("AutoPolicy").a8(this.sNj).build()),this.$.isEditMode?
(this.Y0e(),this.dZg()):E.ULS.sendTraceTag(537154594,306,50,"AutoPolicyManager::InitAugmentationLoop - Skipping annotation activation in view mode.")):E.ULS.sendTraceTag(537154624,306,10,"AutoPolicyManager::InitAugmentationLoop - Failed to instantiate AugmentationLoopManager.")},this.ya,3)}Y0e(){for(const Rb of this.E_)Rb.value.QK&&!Rb.value.lnb&&this.activateAnnotation(Rb.key)}activateAnnotation(Rb){this.Zo.$pa("AutoPolicy",{annotationType:this.E_.na(Rb).annotationType,Jy:!0,uV:this.E_.na(Rb).Ueb});
this.E_.na(Rb).lnb=!0;E.ULS.sendTraceTag(537154590,306,50,`AutoPolicyManager::ActivateAnnotation completed for LabellingSource ${Rb}.`)}Bbi(){for(const Rb of this.E_)Rb.value.lnb&&this.lNb(Rb.key)}lNb(Rb){var dc;null===(dc=this.Zo)||void 0===dc?void 0:dc.O4k(this.E_.na(Rb).annotationType);this.E_.na(Rb).lnb=!1;E.ULS.sendTraceTag(537154589,306,50,`AutoPolicyManager::DeactivateAnnotation completed for LabellingSource ${Rb}.`)}applyPolicyLabel(Rb,dc,$a,Wb){if(this.fa.ka("SupportsOfficeClientCoauthoring"))E.ULS.sendTraceTag(537154579,
306,50,"AutoPolicyManager::ApplyPolicyLabel - SupportsOfficeClientCoauthoring is enabled."),this.afb(Rb,dc,$a,Wb);else{E.ULS.sendTraceTag(537154578,306,50,"AutoPolicyManager::ApplyPolicyLabel - SupportsOfficeClientCoauthoring is disabled.");const rc=xb=>{this.afb(Rb,dc,$a,Wb,0===xb||1===xb||4===xb)};this.sNd(rc,()=>{rc(2)},this.Lbg)}}Srd(Rb,dc){let $a=null,Wb=null;if(!({sensitivityLabel:$a,vVa:Wb}=this.Z2g(Rb)).returnValue)return E.ULS.sendTraceTag(537154577,306,15,"AutoApplyOrRecommendPolicyLabel - Failed to set the sensitivity labels."),
!1;if(Wb&&Wb.Order>=$a.Order)return E.ULS.sendTraceTag(537154576,306,50,"AutoApplyOrRecommendPolicyLabel - The applied label has a higher sensitivty."),!1;this.applyPolicyLabel($a.Id,$a.Id,null,dc);return!0}Trd(Rb,dc){dc=!1;let $a=null,Wb=null;if(!({sensitivityLabel:$a,vVa:Wb}=this.Z2g(Rb)).returnValue)return E.ULS.sendTraceTag(537154575,306,15,"AutoApplyOrRecommendPowerBILabel - Failed to set the sensitivity labels."),{returnValue:!1,Pnb:dc};if(Wb&&Wb.ParentId&&$a.ParentId&&Wb.ParentId===$a.ParentId)return E.ULS.sendTraceTag(537154574,
306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - Label has a common parent with AppliedLabel."),{returnValue:!1,Pnb:dc};if(Wb&&Wb.Order>=$a.Order)return E.ULS.sendTraceTag(537154573,306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - Label does not have a higher priority than AppliedLabel."),{returnValue:!1,Pnb:dc};if(this.fa.ka("SupportsOfficeClientCoauthoring"))E.ULS.sendTraceTag(537154572,306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - SupportsOfficeClientCoauthoring is enabled."),
Rb=this.policyManager.Nn,Rb=!Rb.AppliedPolicyId||!Rb.PolicyLabelAssignmentMethod||Sa.e(Rb.PolicyLabelAssignmentMethod)===Sa.e("standard"),this.x8e($a.Id,Rb);else{E.ULS.sendTraceTag(537154571,306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - SupportsOfficeClientCoauthoring is disabled.");const rc=xb=>{this.x8e($a.Id,0===xb||1===xb||4===xb)};this.sNd(rc,()=>{rc(2)},this.Lbg)}return{returnValue:!0,Pnb:dc}}sNd(Rb,dc,$a,Wb=0){if(this.ki){var rc=this.$.pa.ta.Wh();Yc.b(this.$.pa.ta,this.$.ua.DocumentHostInfo.TenantId,
xb=>{this.ISi(xb,Rb)},()=>{this.HSi(Rb,dc,$a,Wb)},null,null,rc)}else E.ULS.sendTraceTag(537154570,306,15,`AutoPolicyManager: GetPolicyApplicationMethod failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}ISi(Rb,dc){E.ULS.sendTraceTag(537154569,306,50,"AutoPolicyManager: GetPolicyApplicationMethod web service call was successful.");this.ki?!Rb||xd.a(Rb)?E.ULS.sendTraceTag(537154567,306,15,Rb?"AutoPolicyManager: GetPolicyApplicationMethod result has non-status message.":
"AutoPolicyManager: GetPolicyApplicationMethod result is null"):dc(Rb.Result):E.ULS.sendTraceTag(537154568,306,50,`AutoPolicyManager: GetPolicyApplicationMethodSuccessCallback failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}HSi(Rb,dc,$a,Wb){E.ULS.sendTraceTag(537154566,306,15,"AutoPolicyManager: GetPolicyApplicationMethod web service call failed. Trying again");this.ki?Wb>=$a?(E.ULS.sendTraceTag(537154564,306,15,"AutoPolicyManager: GetPolicyApplicationMethod max retries exhausted."),
dc()):this.sNd(Rb,dc,$a,Wb+1):E.ULS.sendTraceTag(537154565,306,50,`AutoPolicyManager: GetPolicyApplicationMethodFailureCallback failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}x8e(Rb,dc){dc?this.afb(Rb,null,null,3,!0):this.afb(null,Rb,null,3,!1)}Z2g(Rb){let dc,$a;$a=dc=null;if(!this.$.isEditMode)return{returnValue:!1,sensitivityLabel:dc,vVa:$a};if(!this.policyManager.Bea())return E.ULS.sendTraceTag(537154529,306,15,"TryGettingSensitivityLabels - Labels are not available."),
{returnValue:!1,sensitivityLabel:dc,vVa:$a};const Wb=this.policyManager.Nn;if(!Wb)return E.ULS.sendTraceTag(537154528,306,15,"TryGettingSensitivityLabels - GetPolicyLabelsData returned an invalid result."),{returnValue:!1,sensitivityLabel:dc,vVa:$a};if(tb.a.Gm(Wb.SensitivityLabels))return E.ULS.sendTraceTag(537154527,306,15,"TryGettingSensitivityLabels - Attempting to apply labels when there are no sensitivity labels available."),{returnValue:!1,sensitivityLabel:dc,vVa:$a};const rc=Wb.AppliedPolicyId;
for(const xb of Rb)for(const ic of Wb.SensitivityLabels)ic.Id===xb&&(!dc||dc.Order<ic.Order)&&(dc=ic),ic.Id===rc&&($a=ic);return dc?{returnValue:!0,sensitivityLabel:dc,vVa:$a}:(E.ULS.sendTraceTag(537154526,306,10,"TryGettingSensitivityLabels - None of the sensitivity labels matched."),{returnValue:!1,sensitivityLabel:dc,vVa:$a})}}Object(h.a)(Vd,"AutoPolicyManager",vb.a,[2]);var ce=a(201),ee=a(16),Je=a(12);class Ue extends ce.ErrorDialog{constructor(Rb){super(Rb,Ue.BJa(Rb))}dF(){super.dF();if(this.error.Appearance&
1&&this.$.Ij&2){const Rb=this.getButton(0);ee.DOMElementExtensions.TOg(Rb.get_element(),Je.a.instance.ia(1315));this.vea(()=>{0===this.returnValue&&this.$.Ij&2&&(E.ULS.sendTraceTag(50373725,306,50,"BlockSenitivityLabelActionDialog : Opening the book in excel desktop."),void u.a.resolve(n.se,{va:0}).then(dc=>{dc.Ixd()}))})}}static BJa(Rb){return Rb.Ij&2?jd.a.nj(3,1,0,1975,0,-1237306487,"SensitivityLabelBlockApplyLabelOpenInDesktop"):jd.a.nj(1,1,0,1976,0,-313914360,"SensitivityLabelBlockApplyLabel")}}
Object(h.a)(Ue,"BlockSenitivityLabelActionDialog",ce.ErrorDialog,[]);var jc=a(25),tc=a(88);class Kc extends vb.a{constructor(Rb,dc,$a,Wb,rc){super();this.statusBarManager=null;this.Xsd=!1;this.zla=null;this.M3c=!1;this.sMa=this.qoe=null;this.tP=this.Mce=!1;this.hTa=this.QTe=this.wsa=this.dVe=this.gy=null;this.Xsf=()=>{E.ULS.sendTraceTag(537154520,306,50,"PolicyManagerWrapper::EnableAutoLabellingInDocument - Triggered EnableAutoLabellingInDocument");const xb=this.Wgk();E.ULS.sendTraceTag(537154519,
306,50,`PolicyManagerWrapper::EnableAutoLabellingInDocument - Annotation registration result: ${xb}.`)};this.ste=(xb,ic)=>{ic?(this.gy=ic.title,this.dVe=ic.HRc,this.wsa=ic.buttonText,this.QTe=ic.Ihg,this.Fla.Mm(27,null),E.ULS.sendTraceTag(537154509,306,50,"Add entry to BusinessBar succeeded. Message is shown to user.")):E.ULS.sendTraceTag(537154510,306,15,"ShowPolicyBusinessBar is called but PolicyTipventArgs is null.")};this.QVg=(xb,ic)=>{const Rc=Object(ra.a)(mc,ic);Rc?Rc.fVg?(E.ULS.sendTraceTag(537154508,
306,15,`ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure because of ${Rc.errorType}`),this.Fla.DQk(Rc.title,Rc.message,Rc.buttonText,Zc=>{Rc.Ela&&(this.Fla.iM(54)&&this.Fla.removeEntry(54),Rc.Ela(Zc))})):E.ULS.sendTraceTag(537154506,306,50,"ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure ShowMessage is false"):(E.ULS.sendTraceTag(537154505,306,10,"ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure args is null"),this.Fla.Mm(48,null))};this.Wze=(xb,ic)=>
{this.Qba&&(E.ULS.sendTraceTag(537154504,306,50,"PolicyManagerWrapper: UpdateLabelInfo called"),ae.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",!1)||(this.Qba.CPg(),this.Qba.qQg()),this.Qba.Qyg(),this.$.Ij&64&&(ic.H1&&this.sMa?this.HIh():this.Qba.X1g()));this.fa.ka("SupportsOfficeClientCoauthoring")&&(xb=this.Lz.Nn,this.hTa=xb.AppliedPolicyId,"null"===this.labelId&&(this.hTa=""),this.M3c&&(xb=xb.PolicyLabelAssignmentMethod&&Sa.e(xb.PolicyLabelAssignmentMethod)===
Sa.e("standard")?4:2,this.applyPolicyLabel(this.labelId,xb,!0,this.qoe)));this.uYh();this.Yxf();this.Yv()};this.ilg=()=>{this.Mce=!0;this.Yxf()};this.wqg=(xb,ic)=>{E.ULS.sendTraceTag(42322116,306,50,`PolicyManagerWrapper.OnSetLabelSucceeded: Applying outcomes for change in policy label. ProtectedFile = ${r.AFrameworkApplication.protectedFile}, ApplyLabelFlag = ${ic.tX}`);this.applyPolicyLabel(ic.GRc,ic.tX,!1,null)};this.jNj=(xb,ic)=>{this.hTa=ic.GRc;if(jd.a.Gx(xb.Errors)){var Rc=jd.a.Wfa(xb.Errors,
[2045508683]);0<Rc.length&&(xb.Errors=jd.a.IS(xb.Errors,[2045508683],"PolicyManagerWrapper: OnApplyManualPolicyLabelSuccessCallback"),this.$.ea.nx(xb.Errors));Rc=jd.a.Wfa(xb.Errors,[2046680228]);0<Rc.length&&(4===ic.tX||1===ic.tX)&&(xb.Errors=jd.a.IS(xb.Errors,[2046680228],"PolicyManagerWrapper: OnApplyManualPolicyLabelSuccessCallback"),this.$.ea.nx(xb.Errors));Rc=xb=null;for(var Zc of this.Lz.Nn.SensitivityLabels)Sd.a.equals(this.labelId,Zc.Id,!1)&&(xb=Zc),Sd.a.equals(ic.CNg,Zc.Id,!1)&&(Rc=Zc);Zc=
{};Zc.ApplyLabelFlag=ic.tX;xb?(Zc.currentLabel="Set",Zc.currentLabelEnabled=xb.Enabled,Zc.currentLabelName=xb.Name?"Set":"NotSet",Zc.currentLabelParentId=xb.ParentId?"Set":"NotSet"):Zc.currentLabel="NotSet";Rc?(Zc.serverLabel="Set",Zc.serverLabelEnabled=Rc.Enabled,Zc.serverLabelName=Rc.Name?"Set":"NotSet",Zc.serverLabelParentId=Rc.ParentId?"Set":"NotSet"):Zc.serverLabel="NotSet";E.ULS.sendTraceTag(541638850,306,15,`PolicyManagerWrapper.OnApplyManualPolicyLabelSuccessCallback Failed. DiagnosticInfo : ${JSON.stringify(Zc)}`)}};
this.WMh=(xb,ic)=>{if(!this.$.workbookContext.HasRoundTrippedHFPart)return!1;const Rc=this.Lz.Nn;if(!Rc)return E.ULS.sendTraceTag(537154502,306,15,"PolicyManagerWrapper.BlockSetSensitivityCall: policyLabelsData is null."),!1;let Zc=null;for(const Kd of Rc.SensitivityLabels)Sd.a.equals(Kd.Id,xb,!1)&&(Zc=Kd);return Zc&&this.J6i(Zc)?(E.ULS.sendTraceTag(50341186,306,50,"PolicyManagerWrapper.BlockSetSensitivityCall: selectedSensitivityLabel has watermark label action."),this.TNk(ic),!0):!1};this.Wfj=()=>
{let xb=!1;!this.$.ua.IsNewWorkbook||this.labelId&&this.labelId.length||(xb=!0);E.ULS.sendTraceTag(537154501,306,50,`PolicyManagerWrapper.IsANewFile: is this a new file : ${xb}`);return xb};this.rbg=(xb,ic)=>{1===ic.j7e?this.$.isEditMode?(E.ULS.sendTraceTag(537154500,306,50,"MandatoryLabellingHandler : Swtiching to view-mode."),this.$.Ma.qh(new Qc.a(-723527778,0,this.$.ii,10,null))):E.ULS.sendTraceTag(537154499,306,50,"MandatoryLabellingHandler : App is already in view-mode."):(this.sMa=ic.sMa,this.$.ea.cK(this.q8e),
this.$.izb(),E.ULS.sendTraceTag(537154498,306,50,"MandatoryLabellingHandler : Swtiching to edit-mode."),this.$.Ma.qh(new Qc.a(-8805455,0,this.$.ii,10,null)))};this.F2e=(xb,ic)=>{ic?(xb=!!(this.$.Ij&64),E.ULS.sendTraceTag(537154496,306,50,`AddMandatoryLabellingBusinessBar User has edit permission : ${xb}`),xb&&(this.$.izb(),this.Fla.BPk(ic.title,ic.message,ic.buttonText,Rc=>{ic.Ela(Rc)}))):E.ULS.sendTraceTag(537154497,306,15,"AddMandatoryLabellingBusinessBar is called but MandatoryLabellingAppHandlerEventArgs is null.")};
this.dEg=()=>{this.Fla.iM(42)&&this.Fla.removeEntry(42)};this.z3g=(xb,ic)=>{ic.ALk&&(E.ULS.sendTraceTag(527716803,306,50,"PolicyManagerWrapper.udpLabelingAppHandler: Open the document in the client when the applied label is a UDP label."),void u.a.resolve(n.se,{va:0}).then(Rc=>{Rc.Ixd()}))};this.q8e=()=>{this.sMa&&this.$.isEditMode?(this.$.ea.XH(this.q8e),this.hRb()):E.ULS.sendTraceTag(537154467,306,15,`ApplyMandatoryLabelOnEditMode : mandatoryPolicyId empty ${!this.sMa} , edit mode : ${this.$.isEditMode}.`)};
this.vxa=()=>{const xb=this.$.ea.Qq;xb&&!Sd.a.equals(xb.AppliedPolicyLabelId,this.labelId,!1)&&(E.ULS.sendTraceTag(537154464,306,50,"PolicyManagerWrapper.HandleWorkbookMetadataChanged: Calling GetPolicyLabels to update statusbar and ribbon control."),E.ULS.shipAssertTag(537154463,306,this.$.isEditMode,"PolicyManagerWrapper.HandleWorkbookMetadataChanged policyId cannot change in read-only mode, this can happen if right policy id is not read from server."),this.fa.ka("SupportsOfficeClientCoauthoring")&&
this.$.isEditMode&&(this.M3c=!0,this.qoe=xb.AppliedPolicyLabelId),this.hTa=xb.AppliedPolicyLabelId,this.hRb())};this.hWd=()=>{let xb=!0;if(!this.$.ea.qX)for(const ic of this.$.ea.Ut)if(!ic.SupportsClientIsMipTrusted){xb=!1;break}E.ULS.sendTraceTag(537154462,306,50,`PolicyManagerWrapper.IsEveryCoauthorInSessionClientMipTrusted : ${xb}`);return xb};this.Cmg=()=>{E.ULS.sendTraceTag(537154461,306,50,"PolicyManagerWrapper.OnLabelUpdate: RTC notification received");this.M3c=!0;this.hRb()};this.$=Wb;this.Lz=
Rb;this.Fla=$a;this.fa=rc;this.Lz.N4e(this.ste);this.Qba=dc}initialize(){this.fa.ka("SupportsPolicies")?(this.hTa=this.fa.Za("AppliedPolicyId"),this.Qba.ho(),this.$.la.fi(29,Rb=>{this.statusBarManager=Rb;Rb.dO(this)}),this.Yv(),Sd.a.Gm(this.fa.Za("HostUserId"))||this.F6j(),this.Qba.Zgk(this.WMh),this.Qba.Shk(this.Wfj),this.Lz.Ugk(this.hWd),this.tP=!0):ya.c()&&appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("Sensitivity",!0));!Sd.a.Gm(this.fa.Za("HostUserId"))&&ae.EwaSettings.Ra(158)&&
this.$.ea.Vn.get(45)&&(E.ULS.sendTraceTag(537154524,306,50,"DataLossPrevention feature is Enabled and launched on Excel."),this.fKi())}ky(Rb){this.addHandler("LabelInfoChangedKey",Rb)}Xx(Rb){this.removeHandler("LabelInfoChangedKey",Rb)}pr(){return!0}xy(Rb,dc){if("QueryPolicyLabel"!==Rb)return!1;if(this.HPa())return dc.Visible=!1,!0;!Sd.a.Gm(dc.LabelText)&&jc.a.Mo(this.$)&&window.setTimeout(()=>{appChrome.api.dispatch(appChrome.actions.setControlCustomTooltip(tc.a.oqc,dc.Alt))},0);dc.Visible=!0;return 32===
r.AFrameworkApplication.yh.ek(m.a.jub,2,dc)}dispose(){this.statusBarManager&&(this.statusBarManager.pN(this),this.statusBarManager=null);this.Qba.t2c();this.Xsd=!1;this.Lz.hok(this.QVg);this.Lz.iok(this.wqg);this.$.ea.KA(this.vxa);if(this.fa.ka("SupportsOfficeClientCoauthoring")){const Rb=this.$.la.lh(292);Rb&&Rb.Qmk(this.Cmg)}this.Lz.dlk(this.F2e);this.Lz.Onk(this.dEg);this.Lz.Ymk(this.rbg);this.Lz.rok(this.z3g);this.Lz.nmk(this.Xsf);this.zla&&(this.zla.dispose(),this.zla=null);super.dispose()}get title(){return this.gy}get HRc(){return this.dVe}get linkText(){return this.wsa}get TVj(){return this.QTe}get labelId(){return this.hTa}Srd(Rb,
dc){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154523,306,15,"AutoApplyOrRecommendPolicyLabel - Called when SupportPolicies is disabled."),!1;if(!this.Mce)return E.ULS.sendTraceTag(537154522,306,15,"AutoApplyOrRecommendPolicyLabel - PolicyData hasn't been received yet."),!1;if(tb.a.Gm(Rb))return!1;this.zla||this.YSd();return this.zla.Srd(Rb,dc)}pod(Rb){return this.Qba.pod(Rb)}Yv(){this.raiseEvent("LabelInfoChangedKey")}fKi(){kb.a.get_instance().Qm(10,()=>{this.Lz.jAc()})}F6j(){kb.a.get_instance().Qm(10,
()=>{this.Lz.RHb(this.Wze);this.Lz.yCh(this.ilg);this.Lz.xCh(this.ilg);this.Lz.vpd(this.QVg);this.Lz.X4e(this.wqg);this.$.ea.mz(this.vxa);this.Lz.H3e(this.F2e);this.Lz.P4e(this.dEg);this.Lz.kDh(this.rbg);this.Lz.QEh(this.z3g);if(this.fa.ka("SupportsOfficeClientCoauthoring")){const Rb=this.$.la.lh(292);Rb&&Rb.aDh(this.Cmg)}E.ULS.sendTraceTag(537154521,306,50,"PolicyManagerWrapper: ApplyAutomaticPolicyLabel enabled and registered GetAutoPolicyLabelHandler");this.Lz.vCh(this.Xsf);this.Lz.t1f()?this.Lz.v7j():
this.Nui()});this.$.Ope("sensitivity",!0)}Nui(){this.fa.ka("SupportsOfficeClientCoauthoring")||this.labelId&&this.labelId.length?this.hRb():this.GEi(this.$.ua.DocumentHostInfo.TenantId)}YSd(){this.zla=new Vd(this.Qba,this.Lz,this.$,this.fa,this.Fla)}Wgk(){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154518,306,10,"PolicyManagerWrapper::RegisterAugmentationLoopAnnotations called when CLP is disabled."),!1;this.zla||this.YSd();return this.zla.$pa(1)}Trd(Rb,dc){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154517,
306,10,"PolicyManagerWrapper::AutoApplyOrRecommendPowerBILabel called when CLP is disabled."),{returnValue:!1,Pnb:!1};if(!this.Mce)return E.ULS.sendTraceTag(537154516,306,15,"PolicyManagerWrapper::AutoApplyOrRecommendPowerBILabel called before PolicyData fetch is complete."),{returnValue:!1,Pnb:!0};this.zla||this.YSd();return this.zla.Trd(Rb,dc)}GEi(Rb){E.ULS.sendTraceTag(537154514,306,50,`PolicyManagerWrapper: Doing GetPolicyLabelId web service call with tenantId length ${Rb.length}`);const dc=this.$.pa.ta.Wh();
Yc.c(this.$.pa.ta,Rb,$a=>{this.gWk($a)},null,null,null,dc)}gWk(Rb){E.ULS.sendTraceTag(537154513,306,50,"PolicyManagerWrapper: GetPolicyLabelId web service call was successful");Rb&&!xd.a(Rb)&&(this.hTa=Rb.Result);this.hRb();this.labelId?E.ULS.sendTraceTag(537154512,306,50,`PolicyManagerWrapper: Fetched LabelId length from custom.xml is ${this.labelId.length}`):E.ULS.sendTraceTag(537154511,306,50,"PolicyManagerWrapper: LabelId is invalid")}hRb(){this.Lz.iRb(this.labelId,void 0,void 0,!1)}uYh(){jc.a.$U()&&
ae.EwaSettings.isChangeGateEnabled("OfficeVSO:8386937_NoCopilotTaskPaneWhenNoExtractPermissions")&&(!r.AFrameworkApplication.protectedFile&&!r.AFrameworkApplication.qAa||r.AFrameworkApplication.enableExtractForProtectedFile||this.$.ti(762629271,-1,0,null))}Yxf(){if(!this.Xsd){this.$.Dm();this.Xsd=!0;this.Fla.RPf();const Rb={};Rb.hasLabel=!!this.labelId&&0<this.labelId.length;Rb.isProtectedFile=this.fa.ka("ProtectedFile");Rb.SupportsPolicies=this.fa.ka("SupportsPolicies");Rb.AreLabelsAvailableForDisplay=
this.Lz.Bea();Rb.SupportsOfficeClientCoauthoring=this.fa.ka("SupportsOfficeClientCoauthoring");Rb.IsAnonymousUser=this.fa.ka("IsAnonymousUser");E.ULS.sendTraceTag(51238051,306,50,`CLPUsage : ${JSON.stringify(Rb)}`)}}HIh(){this.Qba.IIh(this.sMa);this.sMa=null}J6i(Rb){for(const dc of Rb.LabelActions)if(Sd.a.equals(dc.Name,"ApplyWatermark",!1))return!0;return!1}TNk(Rb){Rb?(new Ue(this.$)).Us():E.ULS.sendTraceTag(537154465,306,50,"PolicyManagerWrapper.showBlockApplyLabelDialogDialog: Watermark Dialog box called with showDialog set to false from autoapply.")}applyPolicyLabel(Rb,
dc,$a,Wb){const rc=xc.c(this.Lz.Nn);if(void 0===Rb||null===Rb)Rb="";const xb=new uc;xb.GRc=Rb;xb.CNg=Wb;xb.tX=dc;const ic=this.$.pa.ta;rb.a(this.$.userOperationManager,(Rc,Zc,Kd)=>Yc.a(ic,rc,Rb,this.$.ua.DocumentHostInfo.TenantId,dc,$a,fc.c.call(null,this.jNj,Rc),null,Kd,xb),Rc=>new Nb.a(222,0,Rc),null);this.M3c=!1;this.qoe=null}HPa(){const Rb=u.a.nh(n.Ce);return this.tP&&Rb?Rb.tP():!1}}Object(h.a)(Kc,"PolicyManagerWrapper",vb.a,[168,169,590]);class wd extends nb.a{constructor(Rb){super();this.$=
Rb;this.gm()}create(){const Rb=Object(Id.d)(u.a.resolve(n.C,{va:this.xh})),dc=r.AFrameworkApplication.sj,$a=r.AFrameworkApplication.fa;Aa.TaskExtensions.Xa(Rb,()=>{try{let Wb,rc,xb=void 0;const ic=ae.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarking",!1);ic&&(xb=this.$.GNf());ae.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)?(w.a.instance.register(572,"Common.App.Policy.Contracts.IPolicyManager").yi().Ei(()=>
new ia($a,dc,r.AFrameworkApplication.ra.wL,this.$.ua.MaxGetPolicyRetries,w.a.instance.fj("Common.App.ApplicationFeatureHelper.IApplicationFeatureHelper"))),Wb=w.a.instance.w5b("Common.App.Policy.Contracts.IPolicyManager"),w.a.instance.register(Da,"Common.App.Policy.PolicyActor").as("Common.App.Policy.Contracts.IPolicyActor").yi().Ei(()=>new Da(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,Wb,ic&&xb?[xb]:null)),rc=w.a.instance.w5b("Common.App.Policy.Contracts.IPolicyActor")):
(Wb=new ub.a(()=>new ia($a,dc,r.AFrameworkApplication.ra.wL,this.$.ua.MaxGetPolicyRetries,w.a.instance.fj("Common.App.ApplicationFeatureHelper.IApplicationFeatureHelper"))),rc=new ub.a(()=>new Da(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,Wb,ic&&xb?[xb]:null)));let Rc=this.$.la.lh(274);Rc||(Rc=new Kc(Wb.value,rc.value,Rb.result,this.$,r.AFrameworkApplication.fa),this.$.la.Hh(274,Rc),Rc.initialize());this.Bk(Rc)}catch(Wb){throw E.ULS.sendTraceTag(537154525,306,
10,`PolicyManager was not created successfully [Exception: ${Wb.toString()}]`),Wb;}},this.ya,3)}static Ba(Rb){Rb.la.Hh(275,new wd(Rb))}}Object(h.a)(wd,"PolicyManagerFactory",nb.a,[]);Type.registerNamespace("Common.App.Policy");hb.main();(()=>{Jb.a.gh(Rb=>{wd.Ba(Rb)})})();String(c);window.___1710439927677_closurehack=c}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.policy.js.map/f0eee373c2fa8a8fb9fdb2cd59a7923c/EwaTS.policy.js.map