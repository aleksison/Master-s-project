'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[49],{868:function(z,t,a){a.r(t);z={};a.r(z);t=a(5);var c=a(95),b=a(6),h=a(0),r=a(15);class e{constructor(O,R,J,aa,S,C){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=O;this.WebAffinitizedUrl=R;this.PolicyCookie=J;this.PolicyCookieTTL=aa;this.WasServiceDown=S;this.AffinitizedUrl=C}}Object(h.a)(e,"SafeLinksData",
null,[]);class k{constructor(O,R){this.Q0c=O;this.stopwatch=R}}Object(h.a)(k,"SafeLinksGetUrlReputationRequestData",null,[]);var m=a(47),x=a(59);class n{constructor(O,R,J,aa){this.tUj=S=>{let C="OnGetUrlReputationSuccessCallback: ",L=10;const V=S.data.state;try{const X=m.b(S.data.responseData).reputationResults[0],la=X.navigateUrl.length,Va=V.Q0c.length,na=X.navigateUrl===V.Q0c;X.navigateUrl&&0<X.navigateUrl.length&&(V.Q0c=X.navigateUrl);C+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
S.data.httpStatus,X.verdict,Va.toString(),la.toString(),na.toString());L=50}catch(X){C+=String.format("Exception {0}",X.message)}this.uPf(V,C,L)};this.sUj=S=>{let C="OnGetUrlReputationFailureCallback: ";const L=S.data.state;try{C+=String.format("HttpStatus {0}",S.data.httpStatus)}catch(V){C+=String.format("Exception {0}",V.message)}this.uPf(L,C,10)};this.Ha=O;this.Yn=R;this.imh=J;n.Io=aa}zCa(O,R,J){try{var aa=null;n.Io&&(aa=n.Io.Li("WebServiceCall","SafeLinksGetUrlReputation"));const S=new k(R,aa);
aa={};aa.AffinitizedUrl=O;aa.TargetUrl=R;aa.PolicyCookie=J;const C=m.c(aa);this.Yn.lv(this.imh,2,C,null,!1,2,this.tUj,this.sUj,S,void 0,void 0,3E3,3E3,"36");return!0}catch(S){r.ULS.sendTraceTag(588788033,378,10,S.message)}return!1}uPf(O,R,J){O.stopwatch&&(O.stopwatch.stop(),O.stopwatch=null);r.ULS.sendTraceTag(588788034,378,J,R);x.a.Cm(O.Q0c,void 0,"noopener,noreferrer","SafeLinksNav")}}n.Io=null;Object(h.a)(n,"SafeLinksNavigationHelper",null,[]);var u;(function(O){O[O.Hll=0]="enabledByPolicy";O[O.Tpf=
1]="disabledByPolicy";O[O.wll=2]="disabled_GetPolicyFailure";O[O.xll=3]="disabled_PendingGetPolicyRequest"})(u||(u={}));Object(h.b)("SafeLinksNavigationState",u);var v=a(107),w=a(202),l=a(942),y=a(288),B=a(241),A=a(858),E=a(35),N=a(189),D=a(357);class U{constructor(O,R,J,aa=!1,S=null,C=null){this.RSa=this.QSa=0;this.dWb=this.ifc=!1;this.UEa=null;this.Ibb=!0;this.djc=null;this.tVi=X=>{let la=B.a.rKj,Va="";try{this.ifc=this.dWb=!1;var na=X.data.state;const Ia=({stopwatch:na}=this.S_c(na)).returnValue,
Sa=Object.assign({},{durationMs:Ia});v.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",Sa);r.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",X.data.httpStatus,X.data.responseData.length,Ia);if(X.data.httpStatus!==B.a.EN)Va="Unexpected httpStatus: "+X.data.httpStatus.toString();else{na=null;try{na=m.b(X.data.responseData)}catch(Xa){Va="Exception:"+Xa.toString()+" deserializing response";return}if(na){var db=
na.IsSafeLinksEnabled;if(void 0===db||null===db||0>=db.length)Va="Invalid isSafeLinksEnabledString";else{r.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",db);var ja=U.Ube(db);if(void 0===na.WebAffinitizedUrl||null===na.WebAffinitizedUrl||0>=na.WebAffinitizedUrl.length)Va="Invalid WebAffinitizedUrl";else if(void 0===na.PolicyCookie||null===na.PolicyCookie||0>=na.PolicyCookie.length)Va="Invalid PolicyCookie";else if(void 0===na.PolicyCookieTTL||null===na.PolicyCookieTTL)Va=
"Invalid PolicyCookieTTL";else{var ea=na.WebAffinitizedUrl,Z=na.PolicyCookie,ba=na.AffinitizedUrl,ya=new Date;ya.setMinutes(ya.getMinutes()+(5<na.PolicyCookieTTL?na.PolicyCookieTTL-5:0));var Qa=ya.getTime(),va=new e(db,ea,Z,Qa,!1,ba);this.iOg(va);la=X.data.httpStatus;this.UEa&&(ja?(this.c3g(this.UEa),this.RSa=this.QSa=0):(r.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),v.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,
!0,null),x.a.z0(this.UEa)),this.UEa=null)}}}else Va="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ia){Va="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Ia.toString()}finally{la!==B.a.EN&&this.tPf(la,Va)}};this.sVi=X=>{this.ifc=!1;let la=500,Va="";try{let na=X.data.state;const db=({stopwatch:na}=this.S_c(na)).returnValue,ja=Object.assign({},{durationMs:db});la=X.data.httpStatus;v.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest",
"HttpStatusCode_"+la.toString(),!1,!0,ja);Va="Request Failed, Status="+A.a[X.data.status]+" Duration: "+db}catch(na){Va="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+na.toString()}finally{this.tPf(la,Va)}};r.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.Ha=O;this.Yn=R;this.DG=J;U.Io=C;this.Bvh=aa?this.Ha.Za("SafeLinksHandlerWebServiceBase"):this.Ha.Za("WebServiceBase");this.kvh=this.Ha.Za("SafeLinksHashedUserId");this.Kel=this.Ha.Za("SafeLinksWorkloadIdHeaderValue");
this.Sgc=this.Ha.Lj("SafeLinksMaxGetPolicyBootRetries",2);this.Tgc=this.Ha.Lj("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.Sfc=this.isSafeLinksEnabledForUser();this.Rfc=this.tqj();U.N_e=this.Ha.Za("UserPrincipalName")||"";U.LZe=this.Ha.Za("TenantId")||"";r.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.Sfc,this.Rfc);if(this.Sfc&&this.Rfc){R=(O=this.rJa())?O.IsSafeLinksEnabled.toLowerCase():"";J=this.lYd();r.ULS.sendTraceTag(36231312,378,
50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",R,J);var L=!O||"unknown"===R||O.WasServiceDown||J,V=w.a.sy();V&&(V.set("shouldGetSafeLinksDataFromServer",L.toString()),V.set("isSafeLinksEnabledCacheValue",R.toString()));S?(this.Ibb=!1,S.execute(X=>{X.isFeatureEnabled("MsoUrlreputation",!0).then(la=>{this.Ibb=la;V.set("isUserLicensedForSafeLinks",this.Ibb.toString());v.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",D.b.FailureBased,"jpittsdirects",V);this.Ibb&&L&&
this.QBc(!0);return null})})):(v.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",D.b.FailureBased,"jpittsdirects",V),L&&this.QBc(!0))}}get appName(){return this.DG}get S4c(){return this.Bvh}get userId(){return this.kvh}get kNf(){try{if(""===U.Wad){const O={};O["X-AppName"]=this.appName;O["X-AppVersion"]=b.AFrameworkApplication.buildVersion;O.OS=this.Ha.Za("PlatformNameAndVersion")||"";const R=JSON.stringify(O);U.Wad=window.self.btoa(R)}}catch(O){r.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",
O.message)}return U.Wad}get JSi(){const O=this.S4c?this.S4c+"/":"",R=new y.QueryStringBuilder("SafeLinksHandler.ashx");R.cq("app",this.appName);this.Ha.ka("SafeLinksUseDebugHeader")&&R.cq("action","debug");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&R.cq("s2satpop","1");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&R.cq("s2se03","1");return String.format("{0}{1}&{2}",O,R.toString(),b.AFrameworkApplication.Jo)}get HZi(){const O=
this.S4c?this.S4c+"/":"",R=new y.QueryStringBuilder("SafeLinksHandler.ashx");R.cq("app",this.appName);this.Ha.ka("SafeLinksUseDebugHeader")&&R.cq("action","debug");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&R.cq("s2satpop","1");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&R.cq("s2saat","1");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&R.cq("s2se03","1");this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",
!1)&&R.cq("sladpar",this.kNf);R.cq("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",O,R.toString(),b.AFrameworkApplication.Jo)}get mJj(){U.djd||(U.djd=new n(this.Ha,this.Yn,this.HZi,U.Io));return U.djd}zCa(O){if(!O)return r.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var R=this.cmj(O);r.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",
R,this.Sfc,this.Rfc,this.Ibb);if(!(R&&this.Sfc&&this.Rfc&&this.Ibb))return!1;R=0;const J=({state:R}=this.qNk()).returnValue;r.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",u[R]);const aa=w.a.sy();aa&&aa.set("SafeLinksNavigationState",u[R]);v.Health.instance.recordKpiUsage("SafeLinksNavigations",D.b.FailureBased,"jpittsdirects",aa);if(!J)return 2!==R&&3!==R||v.Health.instance.recordKpiFailure("SafeLinksNavigations",u[R],!1,!0,null),!1;r.ULS.sendTraceTag(26019601,
378,50,"Using safelinks to navigate hyperlink");if(this.ANk())return this.lYd()?!1:this.mJj.zCa(this.dEi(),O,this.nKf());if(!this.lYd())return this.c3g(O),!0;this.UEa=O;r.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.dWb=!1;this.QBc();return!0}cmj(O){O=O.toLowerCase();const R=this.Ha.pA("SafeLinksUnsupportedProtocols");if(R)for(let J=0;J<R.length;J++)if(O.startsWith(R[J]))return!1;return!0}QBc(O=!1){var R=w.a.sy();R&&R.set("isOnBootRequest",O.toString());
v.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",D.b.SuccessBased,"jpittsdirects",R);v.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",D.b.FailureBased,"jpittsdirects",R);R=this.yyd("SafeLinksGetPolicy");this.Yn.lv(this.JSi,1,null,null,!0,2,this.tVi,this.sVi,R,void 0,void 0,void 0,void 0,"23");this.dWb=O;this.ifc=!0;O?this.QSa++:this.RSa++}tPf(O,R=""){try{if(r.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",O,R),this.QSa<
this.Sgc&&this.RSa<this.Tgc)this.QBc(this.dWb);else{this.dWb=!1;r.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.QSa,this.RSa,O,R);R=null;const J=w.a.sy();J&&(J.set("HttpStatus",O.toString()),R=Object.assign({},{extendedProperties:J}));v.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,R);const aa=new e("false","","",0,!0,"");this.iOg(aa);this.UEa&&
(r.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),v.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),x.a.z0(this.UEa),this.UEa=null)}}catch(J){r.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",J.toString())}}c3g(O){const R=this.nKf(),J=this.A_i(),aa={};aa.Url=O;aa.SafeLinksCookie=R;aa.CorrelationId=N.a.create().toString();aa.WorkloadId=
this.Kel;aa.UserAgentInfo=E.a.g$+"|"+this.appName;this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&(aa.User=U.N_e,aa.TenantId=U.LZe,aa.AdditionalProperties=this.kNf);r.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",aa.CorrelationId);x.a.N2b(x.a.L2(4),J,aa)}isSafeLinksEnabledForUser(){const O=this.Ha.Za("IsSafeLinksEnabledForUser");return O?U.Ube(O):!1}tqj(){const O=this.Ha.pA("SafeLinksDisabledBrowsers");if(E.a.$0){if(this.Ha.Jv("SafeLinksForTeamsIsEnabled")&&
this.Ha.ka("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(O,"Electron"))return!1}else if(Array.contains(O,E.a.g$))return!1;return"officecomhwa"===(this.Ha.Za(b.AFrameworkApplication.UZ)||"").toLowerCase()?!1:!0}ANk(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.Ha.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&E.a.b1?!0:E.a.$0||E.a.MJc}qNk(){let O;O=0;const R=this.rJa(),J=R?R.IsSafeLinksEnabled:"";if(""!==J)return R.WasServiceDown?
(r.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===J.toLowerCase()?(r.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:U.Ube(J),state:O};if(this.ifc)return O=3,r.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:O};if(this.QSa>=this.Sgc||this.RSa>=this.Tgc)return O=2,r.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",
this.QSa,this.Sgc,this.RSa,this.Tgc),{returnValue:!1,state:O};r.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.Sgc+this.Tgc-(this.QSa+this.RSa));return{returnValue:!0,state:O}}nKf(){const O=this.rJa();return O?O.PolicyCookie:""}A_i(){const O=this.rJa();return O?O.WebAffinitizedUrl:""}dEi(){const O=this.rJa();return O?O.AffinitizedUrl:""}cLi(){const O=
new Date;try{const R=this.rJa();O.setTime(R?R.PolicyCookieTTL:0)}catch(R){r.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",R)}return O}lYd(){const O=this.cLi();return!!O&&O.getTime()<Date.now()}rJa(){if(!this.djc){const O=l.a.instance.getItem(this.userId);if(!O||""===O)return null;this.djc=JSON.parse(O)}return this.djc}iOg(O){if(void 0===O||null===O)throw Error.argumentNull("safeLinksData");if(void 0===O.IsSafeLinksEnabled||null===O.IsSafeLinksEnabled||
0>=O.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.djc=O;O.WasServiceDown||this.Uel(O)}Uel(O){O=JSON.stringify(O);l.a.instance.setItem(this.userId,O)}yyd(O){return void 0!==U.Io&&null!==U.Io?U.Io.Li("WebServiceCall",O):null}S_c(O){if(void 0!==O&&null!==O){const R=O.zi;O.stop();return{returnValue:R,stopwatch:null}}return{returnValue:null,stopwatch:O}}static Ube(O){return"false"!==O.toLowerCase()?!0:!1}}U.Io=null;U.djd=null;U.LZe="";U.N_e="";U.Wad="";Object(h.a)(U,
"SafeLinksManager",null,[266]);const K=O=>{switch(O){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},M=O=>{switch(O){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Object(c.b)(t.xf,{Ek:"singleton"})(()=>new U(b.AFrameworkApplication.fa,b.AFrameworkApplication.sj,String.format("{0}-{1}",K(b.AFrameworkApplication.ra.$g.kn),M(b.AFrameworkApplication.ra.$g.QMa))));String(z);window.___1710439927692_closurehack=z},
942:function(z,t,a){a.d(t,"a",function(){return b});z=a(0);var c=a(15);class b{constructor(){this.BEa=!1}getItem(h){try{if(b.mha(h)&&this.localStorage)return this.localStorage.getItem(h)}catch(r){c.ULS.sendTraceTag(593512200,306,15,"LocalStorageWrapper Exception: {0} ",r.message)}return null}setItem(h,r){try{b.mha(h)&&this.localStorage&&this.localStorage.setItem(h,r)}catch(e){c.ULS.sendTraceTag(593512199,306,15,"LocalStorageWrapper Exception: {0} ",e.message)}}removeItem(h){try{b.mha(h)&&this.localStorage&&
this.localStorage.removeItem(h)}catch(r){c.ULS.sendTraceTag(593512198,306,15,"LocalStorageWrapper Exception: {0} ",r.message)}}get localStorage(){let h=null;if(!this.BEa)try{localStorage&&(h=localStorage)}catch(r){this.BEa=!0}return h}static get instance(){b.Va||(b.Va=new b);return b.Va}static mha(h){return void 0===h||null===h||0>=h.length?!1:!0}}b.Va=null;Object(z.a)(b,"LocalStorageWrapper",null,[109])}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.safelinks.js.map/99b8dc528e7ad91f0ad6ff828a2e3c4c/EwaTS.safelinks.js.map